<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messages AI Chat</title>
    <script type="module" src="./common.js"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      #chat {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      vaadin-message-list {
        flex: 1 1 auto;
      }
    </style>

    <script type="module">
      import '@vaadin/message-input';
      import '@vaadin/message-list';
      import { Notification } from '@vaadin/notification';

      /**
       * Simulates streaming text from an AI model
       * @returns {Object} Subscription object with onNext and onComplete methods
       */
      function simulateMessageStream() {
        // Sample response to simulate an AI assistant message
        const answerMarkdown = `
I can help you with:

1. **Answering questions** ‚Äì from quick facts to in-depth explanations.  
2. **Explaining concepts** ‚Äì breaking down complex ideas into clear, step-by-step logic.  
3. **Brainstorming & creativity** ‚Äì generating outlines, stories, code snippets, or design ideas.  
4. **Guidance & troubleshooting** ‚Äì walking you through processes or helping debug issues.  

---

### How to get the most out of me üõ†Ô∏è

| Step | What to do | Why it matters |
|------|------------|----------------|
| 1Ô∏è‚É£ | **State your goal clearly.** | A precise prompt yields a precise answer. |
| 2Ô∏è‚É£ | **Add constraints or context.** <br>*(e.g., audience, length, tone)* | Tailors the response to your needs. |
| 3Ô∏è‚É£ | **Ask follow-ups.** | We can iterate until you're satisfied. |

---

#### Example

> **You:** "Explain quantum entanglement in simple terms."

> **Me:**  
> *Imagine two coins spun so perfectly in sync that the moment you look at one and see "heads," the other coin‚Äîno matter how far away‚Äîwill instantly show "tails." In quantum physics, particles can become linked in just that way‚Ä¶*  

---

Need anything else? Just let me know, and I'll jump right in! ‚ú®`;

        let onNextCallback = null;
        let onCompleteCallback = null;

        // Create subscription interface
        const subscription = {
          onNext: (callback) => {
            onNextCallback = callback;

            // Simulate token-by-token streaming with a small delay
            const tokenLength = 10;

            setTimeout(async () => {
              let tokenIndex = 0;
              while (tokenIndex < answerMarkdown.length) {
                const token = answerMarkdown.substring(tokenIndex, tokenIndex + tokenLength);
                tokenIndex += tokenLength;
                onNextCallback(token);
                await new Promise((resolve) => setTimeout(resolve, 100));
              }
              if (onCompleteCallback) {
                onCompleteCallback();
              }
            }, 1000);

            return subscription;
          },
          onComplete: (callback) => {
            onCompleteCallback = callback;
            return subscription;
          },
        };

        return subscription;
      }

      function createItem(text, assistant = false) {
        return {
          text,
          time: 'Just now',
          userName: assistant ? 'Assistant' : 'User',
          userColorIndex: assistant ? 2 : 1,
        };
      }

      const list = document.querySelector('vaadin-message-list');
      const input = document.querySelector('vaadin-message-input');

      // Set initial messages
      list.items = [
        {
          text: 'Can you help me analyze these Q3 financial documents? I need a summary of the key findings and any concerns you spot.',
          time: 'Yesterday',
          userName: 'User',
          userColorIndex: 1,
          attachments: [
            { name: 'proposal.pdf', url: '#proposal.pdf', type: 'application/pdf' },
            {
              name: 'budget.xlsx',
              url: '#budget.xlsx',
              type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            },
            {
              name: 'chart.png',
              url: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150"%3E%3Crect fill="%23f0f0f0" width="200" height="150"/%3E%3Crect fill="%234CAF50" x="20" y="100" width="30" height="40"/%3E%3Crect fill="%232196F3" x="60" y="70" width="30" height="70"/%3E%3Crect fill="%23FF9800" x="100" y="50" width="30" height="90"/%3E%3Crect fill="%239C27B0" x="140" y="30" width="30" height="110"/%3E%3Ctext x="100" y="20" text-anchor="middle" font-size="12" fill="%23333"%3EQ3 Growth%3C/text%3E%3C/svg%3E',
              type: 'image/svg+xml',
            },
          ],
        },
        {
          text: "I've reviewed your Q3 financial documents. Here's a summary:\n\n**Key Findings:**\n- Revenue increased 12% compared to Q2\n- Operating costs remained stable\n- The chart shows positive growth trends\n\n**Concerns:**\n- Marketing spend is 15% over budget\n- Cash flow projections need revision\n\nWould you like me to elaborate on any of these points?",
          time: 'Yesterday',
          userName: 'Assistant',
          userColorIndex: 2,
        },
      ];

      // Handle attachment clicks
      list.addEventListener('attachment-click', (e) => {
        const { attachment } = e.detail;
        Notification.show(`Attachment clicked: ${attachment.name}`, { position: 'bottom-start' });
      });

      // Handle new messages from user
      input.addEventListener('submit', async (e) => {
        // Add user message to the list
        list.items = [...list.items, createItem(e.detail.value)];

        // Create empty assistant message that will be populated gradually
        const newAssistantItem = createItem('', true);

        // Simulate AI typing response token by token
        simulateMessageStream().onNext((token) => {
          newAssistantItem.text += token;
          // Force UI update by creating a new array
          list.items = list.items.includes(newAssistantItem) ? [...list.items] : [...list.items, newAssistantItem];
        });
      });
    </script>
  </head>

  <body>
    <div id="chat">
      <vaadin-message-list markdown></vaadin-message-list>
      <vaadin-message-input></vaadin-message-input>
    </div>
  </body>
</html>
