<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messages AI Chat</title>
    <script type="module" src="./common.js"></script>

    <script type="module">
      import '@vaadin/message-input';
      import '@vaadin/message-list';
      import '@vaadin/markdown';
      import { render, html } from 'lit';

      function simulateMessageStream() {
        const answerMarkdown = `## Hello! I‚Äôm your AI assistant ü§ñ

I can help you with:

1. **Answering questions** ‚Äì from quick facts to in-depth explanations.  
2. **Explaining concepts** ‚Äì breaking down complex ideas into clear, step-by-step logic.  
3. **Brainstorming & creativity** ‚Äì generating outlines, stories, code snippets, or design ideas.  
4. **Guidance & troubleshooting** ‚Äì walking you through processes or helping debug issues.  

---

### How to get the most out of me üõ†Ô∏è

| Step | What to do | Why it matters |
|------|------------|----------------|
| 1Ô∏è‚É£ | **State your goal clearly.** | A precise prompt yields a precise answer. |
| 2Ô∏è‚É£ | **Add constraints or context.** <br>*(e.g., audience, length, tone)* | Tailors the response to your needs. |
| 3Ô∏è‚É£ | **Ask follow-ups.** | We can iterate until you‚Äôre satisfied. |

---

#### Example

> **You:** ‚ÄúExplain quantum entanglement in simple terms.‚Äù

> **Me:**  
> *Imagine two coins spun so perfectly in sync that the moment you look at one and see ‚Äúheads,‚Äù the other coin‚Äîno matter how far away‚Äîwill instantly show ‚Äútails.‚Äù In quantum physics, particles can become linked in just that way‚Ä¶*  

---

Need anything else? Just let me know, and I‚Äôll jump right in! ‚ú®`;

        let onNextCallback = null;
        let onCompleteCallback = null;

        const subscription = {
          onNext: (callback) => {
            onNextCallback = callback;

            const tokenLength = 10;

            setTimeout(async () => {
              let tokenIndex = 0;
              while (tokenIndex < answerMarkdown.length) {
                const token = answerMarkdown.substring(tokenIndex, tokenIndex + tokenLength);
                tokenIndex += tokenLength;
                onNextCallback(token);
                await new Promise((resolve) => setTimeout(resolve, 100));
              }
              onCompleteCallback();
            }, 1000);

            return subscription;
          },
          onComplete: (callback) => {
            onCompleteCallback = callback;
            return subscription;
          },
        };

        return subscription;
      }

      function createUserMessage(text) {
        return {
          text,
          time: 'Just now',
          userName: 'User',
          userColorIndex: 1,
        };
      }

      function createAssistantMessage(text) {
        return {
          text,
          time: 'Just now',
          userName: 'Assistant',
          userColorIndex: 2,
        };
      }

      const list = document.querySelector('vaadin-message-list');
      list.renderer = (root, _list, { item }) => {
        render(html`<vaadin-markdown .markdown="${item.text}"></vaadin-markdown>`, root);
      };

      list.items = [
        createUserMessage('Hello! Can you help me with a question?'),
        createAssistantMessage("Of course! I'm here to help. What's your question?"),
      ];

      const input = document.querySelector('vaadin-message-input');
      input.addEventListener('submit', async (e) => {
        list.items = [...list.items, createUserMessage(e.detail.value)];
        input.disabled = true;

        const newAssistantItem = createAssistantMessage('');

        simulateMessageStream()
          .onNext((token) => {
            if (!list.items.includes(newAssistantItem)) {
              list.items = [...list.items, newAssistantItem];
            }
            newAssistantItem.text += token;
            list.items = [...list.items];
          })
          .onComplete(() => {
            input.disabled = false;
          });
      });
    </script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      #chat {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      vaadin-message-list {
        flex: 1;
        scroll-snap-type: y proximity;
      }

      vaadin-message-list::after {
        display: block;
        content: '';
        scroll-snap-align: end;
        min-height: 1px;
      }
    </style>
  </head>

  <body>
    <div id="chat">
      <vaadin-message-list></vaadin-message-list>
      <vaadin-message-input> </vaadin-message-input>
    </div>
  </body>
</html>
