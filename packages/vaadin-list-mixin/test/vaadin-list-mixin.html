<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-list-mixin tests</title>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>
  <link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
  <link rel="import" href="../vaadin-list-item-mixin.html">
  <link rel="import" href="../vaadin-list-mixin.html">
</head>

<body>
  <dom-module id="test-list-element">
    <template>
      <div id="scroll">
        <slot></slot>
      </div>
    </template>
    <script>
      document.addEventListener('WebComponentsReady', () => {
        class TestWrapper extends Vaadin.ListMixin(Polymer.Element) {
          static get is() {
            return 'test-list-element';
          }

          get _scrollerElement() {
            return this.$.scroll;
          }
        }
        customElements.define('test-list-element', TestWrapper);
      });
    </script>
  </dom-module>

  <dom-module id="test-item-element">
    <template>
      <slot></slot>
    </template>
    <script>
      document.addEventListener('WebComponentsReady', () => {
        class TestElement extends Vaadin.ListItemMixin(Polymer.Element) {
          static get is() {
            return 'test-item-element';
          }
        }
        customElements.define('test-item-element', TestElement);

        /**
         * @namespace Vaadin
         */
        window.Vaadin = window.Vaadin || {};
        Vaadin.TabElement = TestElement;
      });
    </script>
  </dom-module>

  <test-fixture id="nav">
    <template>
      <test-list-element style="width: 400px; height: 400px;">
        <test-item-element>Foo</test-item-element>
        <test-item-element>Bar</test-item-element>
        <separator>___</separator>
        <test-item-element disabled>Baz</test-item-element>
        <test-item-element>Baz</test-item-element>
      </test-list-element>
    </template>
  </test-fixture>

  <script>
    function arrowDown(target) {
      MockInteractions.keyDownOn(target, 40, [], 'ArrowDown');
    }

    function arrowRight(target) {
      MockInteractions.keyDownOn(target, 39, [], 'ArrowRight');
    }

    function arrowRightIE(target) {
      MockInteractions.keyDownOn(target, 39, [], 'Right');
    }

    function arrowUp(target) {
      MockInteractions.keyDownOn(target, 38, [], 'ArrowUp');
    }

    function arrowLeft(target) {
      MockInteractions.keyDownOn(target, 37, [], 'ArrowLeft');
    }

    function home(target) {
      MockInteractions.keyDownOn(target, 36, [], 'Home');
    }

    function end(target) {
      MockInteractions.keyDownOn(target, 35, [], 'End');
    }

    function keyDownChar(target, letter, modifier) {
      MockInteractions.keyDownOn(target, letter.charCodeAt(0), modifier, letter);
    }

    describe('vaadin-list-mixin', () => {
      var nav;

      beforeEach(() => nav = fixture('nav'));

      it('should filter appropriate items from its children in dom', () => {
        expect(nav._navItems.length).to.be.equal(4);
      });

      it('should not select any item by default', () => {
        nav._navItems.forEach(e => expect(nav._navItems[0].selected).to.be.false);
      });

      it('should select an item when `selected` property is set', () => {
        nav.selected = 2;
        expect(nav._navItems[2].selected).to.be.true;
      });

      describe('tabIndex', () => {
        it('should set tabIndex=-1 to all items, but the first', () => {
          [0, -1, -1, -1].forEach((val, idx) => expect(nav._navItems[idx].tabIndex).to.be.equal(val));
        });

        it('should move tabIndex when moving focus', () => {
          nav._focus(3);
          [-1, -1, -1, 0].forEach((val, idx) => expect(nav._navItems[idx].tabIndex).to.be.equal(val));
        });
      });

      describe('focus', () => {

        beforeEach(() => nav._focus(0));

        it('should move focus to next element on "arrow-right" keydown', () => {
          arrowRight(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('should move focus when event.key name does not include the Arrow prefix (IE)', () => {
          arrowRightIE(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('should move focus to prev element on "arrow-left" keydown', () => {
          arrowRight(nav);
          arrowLeft(nav);
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('should move focus to next element on "arrow-down" keydown', () => {
          nav.vertical = true;
          arrowDown(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('should move focus to prev element on "arrow-up" keydown', () => {
          nav.vertical = true;
          arrowDown(nav);
          arrowUp(nav);
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('should move focus to first element on "home" keydown', () => {
          nav._focus(3);
          home(nav);
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('should move focus to second element if first is disabled on "home" keydown', () => {
          nav._navItems[0].disabled = true;
          nav._focus(3);
          home(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('should move focus to last element on "end" keydown', () => {
          end(nav);
          expect(nav._navItems[3].focused).to.be.true;
        });

        it('should move focus to the most closed enabled element if last is disabled on "end" keydown', () => {
          nav._navItems[3].disabled = true;
          end(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('if focus is in last element should move focus to first element on arrow-right', () => {
          nav._focus(nav._navItems.length - 1);
          arrowRight(nav);
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('if focus is in first element should move focus to last element on arrow-left', () => {
          arrowLeft(nav);
          expect(nav._navItems[nav._navItems.length - 1].focused).to.be.true;
        });

        it('focus loop should skip disabled items', () => {
          arrowRight(nav);
          arrowRight(nav);
          expect(nav._navItems[3].focused).to.be.true;
        });

        it('should focus the next item whose first letter matches the key pressed', () => {
          keyDownChar(nav, 'b');
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('key search should be case insensitive', () => {
          keyDownChar(nav, 'B');
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('key search should not happen if a modifier key is pressed', () => {
          keyDownChar(nav, 'b', 'shift');
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('key search should skip disabled items', () => {
          keyDownChar(nav, 'b');
          keyDownChar(nav, 'b');
          expect(nav._navItems[3].focused).to.be.true;
        });

        it('focus should loop when search by first letter', () => {
          nav._focus(nav._navItems.length - 1);
          keyDownChar(nav, 'b');
          expect(nav._navItems[1].focused).to.be.true;
        });
      });

      describe('orientation', () => {
        it('if not vertically oriented, aria-orientation attribute should be set to horizontal', () => {
          expect(nav.getAttribute('aria-orientation')).to.be.equal('horizontal');
        });

        it('if vertically oriented, aria-orientation attribute should be set to vertical', () => {
          nav.vertical = true;
          expect(nav.getAttribute('aria-orientation')).to.be.equal('vertical');
        });

        it('should have vertical attribute on each item', () => {
          nav.vertical = true;
          nav.querySelectorAll('test-item-element').forEach(item => {
            expect(item.hasAttribute('vertical')).to.be.true;
          });
        });

        it('should not have vertical attribute on each item', () => {
          nav.vertical = true;
          nav.vertical = false;
          nav.querySelectorAll('test-item-element').forEach(item => {
            expect(item.hasAttribute('vertical')).to.be.false;
          });
        });

        it('should have vertical attribute on newly added item', done => {
          nav.vertical = true;

          const item = document.createElement('test-item-element');
          item.innerText = 'foo';
          nav.appendChild(item);

          setTimeout(() => {
            expect(item.hasAttribute('vertical')).to.be.true;
            done();
          }, 0);
        });
      });

    });
  </script>
</body>
