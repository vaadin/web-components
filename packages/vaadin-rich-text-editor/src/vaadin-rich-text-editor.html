<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">
<link rel="import" href="../../vaadin-license-checker/vaadin-license-checker.html">

<link rel="import" href="../vendor/quill.html">

<dom-module id="vaadin-rich-text-editor">
  <template>
    <style include="quill-snow-styles">
      :host {
        display: block;
      }

      :host([hidden]) {
        display: none !important;
      }

      [part="editor"] {
        min-height: 200px;
      }
    </style>

    <!-- Create toolbar container -->
    <div part="toolbar">

      <!-- Bold -->
      <button class="ql-bold" part="btn-bold"></button>

      <!-- Italic -->
      <button class="ql-italic" part="btn-italic"></button>

      <!-- Underline -->
      <button class="ql-underline" part="btn-underline"></button>

      <!-- Strike -->
      <button class="ql-strike" part="btn-strike"></button>

      <!-- Header buttons -->
      <button type="button" class="ql-header" value="1" part="btn-h1"></button>
      <button type="button" class="ql-header" value="2" part="btn-h2"></button>

      <!-- Subscript and superscript -->
      <button class="ql-script" value="sub" part="btn-sub"></button>
      <button class="ql-script" value="super" part="btn-super"></button>

      <!-- List buttons -->
      <button type="button" class="ql-list" value="bullet" part="btn-bullet-list"></button>
      <button type="button" class="ql-list" value="ordered" part="btn-ordered-list"></button>

      <!-- Align buttons -->
      <button type="button" class="ql-align" value="" part="btn-align-left"></button>
      <button type="button" class="ql-align" value="center" part="btn-align-center"></button>
      <button type="button" class="ql-align" value="right" part="btn-align-right"></button>
      <button type="button" class="ql-align" value="justify" part="btn-align-justify"></button>

      <!-- Blockquote -->
      <button type="button" class="ql-blockquote" part="btn-blockquote"></button>

      <!-- Code block -->
      <button type="button" class="ql-code-block" part="btn-code-block"></button>

      <!-- Clean -->
      <button type="button" class="ql-clean" part="btn-clean"></button>
    </div>

    <div part="editor"></div>

  </template>

  <script>
    (function() {
      'use strict';

      const Quill = window.Quill;
      const DEFAULT_VALUE = '[{"insert":"\\n"}]';

      /**
       * `<vaadin-rich-text-editor>` is a Web Component for rich text editing.
       *
       * ```
       * <vaadin-rich-text-editor></vaadin-rich-text-editor>
       * ```
       *
       * @memberof Vaadin
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @demo demo/index.html
       */
      class RichTextEditorElement extends Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element)) {
        static get is() {
          return 'vaadin-rich-text-editor';
        }
        static get version() {
          return '0.1.0';
        }

        static get properties() {
          return {
            /**
             * Value is a list of the operations which describe change to the document.
             * Each of those operations describe the change at the current index.
             * They can be an `insert`, `delete` or `retain`. The format is as follows:
             *
             * ```js
             *  [
             *    { insert: 'Hello World' },
             *    { insert: '!', attributes: { bold: true }}
             *  ]
             * ```
             *
             * See also https://github.com/quilljs/delta for detailed documentation.
             */
            value: {
              type: String,
              observer: '_valueChanged',
              notify: true,
              value: DEFAULT_VALUE
            }
          };
        }

        /**
         * HTML representation of the rich text editor content.
         * @type {string}
         */
        get htmlValue() {
          const className = 'ql-editor';
          const editor = this.shadowRoot.querySelector(`.${className}`);
          let content = editor.innerHTML;

          // Remove style-scoped classes that are appended when ShadyDOM is enabled
          Array.from(editor.classList).forEach(c => content = content.replace(new RegExp('\\s*' + c, 'g'), ''));

          // Remove Quill classes, e.g. ql-syntax, except for align
          content = content.replace(/\s*ql-(?!align)[\w\-]*\s*/g, '');

          // Replace Quill align classes with inline styles
          ['right', 'center', 'justify'].forEach(align => {
            content = content.replace(new RegExp(` class=[\\\\]?"\\s?ql-align-${align}[\\\\]?"`, 'g'), ` style="text-align: ${align}"`);
          });

          content = content.replace(/ class=""/g, '');

          return content;
        }

        ready() {
          super.ready();

          const editor = this.shadowRoot.querySelector('[part="editor"]');
          const toolbar = this.shadowRoot.querySelector('[part="toolbar"]');

          this._editor = new Quill(editor, {
            modules: {
              toolbar: toolbar
            },
            placeholder: 'Type something...',
            theme: 'snow'
          });

          this._editor.on('text-change', (delta, oldDelta, source) => {
            this.__userInput = source === 'user';
            this.value = JSON.stringify(this._editor.getContents().ops);
            this.__userInput = false;
          });
        }

        _clear() {
          this._editor.deleteText(0, this._editor.getLength(), 'silent');
        }

        _valueChanged(value, oldValue) {
          // Should not do anything on initialization of the default value
          if (!oldValue) {
            return;
          }
          // prevent editor contents from being reset by user input
          if (this.__userInput) {
            return;
          }
          if (value == null || value === '') {
            this.value = DEFAULT_VALUE;
            this._clear();
            return;
          }

          let parsedValue;
          try {
            parsedValue = JSON.parse(value);
            if (!Array.isArray(parsedValue)) {
              throw new Error('Incorrect value: expected JSON string with array of objects, got:', value);
            }
          } catch (err) {
            // Use old value in case new one is not suitable
            this.value = oldValue;
            console.error('Invalid JSON structure:', err);
            return;
          }
          const delta = new Quill.imports.delta(parsedValue);
          // suppress text-change event to prevent infinite loop
          this._editor.setContents(delta, 'silent');
        }
      }

      customElements.define(RichTextEditorElement.is, RichTextEditorElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.RichTextEditorElement = RichTextEditorElement;

      const devModeCallback = window.Vaadin.developmentModeCallback;
      const licenseChecker = devModeCallback && devModeCallback['vaadin-license-checker'];
      if (typeof licenseChecker === 'function') {
        licenseChecker(RichTextEditorElement);
      }
    })();
  </script>
</dom-module>
