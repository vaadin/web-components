<!--
@license
Vaadin Charts

Copyright (C) 2015 Vaadin Ltd

This program is available under Commercial Vaadin Add-On License 3.0 (CVALv3).

See the file LICENSE.md distributed with this software for more information about licensing.

See <a href="https://vaadin.com/license/cval-3">the website</a> for the complete license.
-->
<script src="../highcharts/adapters/standalone-framework.js"></script>
<script src="../highcharts/highcharts.js"></script>
<script src="../highcharts/highcharts-more.js"></script>
<script src="../highcharts/highcharts-3d.js"></script>
<script src="../highcharts/modules/heatmap.js"></script>
<script src="../highcharts/modules/treemap.js"></script>
<script src="../highcharts/modules/drilldown.js"></script>
<script src="../highcharts/modules/data.js"></script>
<script src="../highcharts/modules/exporting.js"></script>
<script src="../highcharts/modules/funnel.js"></script>
<script src="../highcharts/modules/solid-gauge.js"></script>
<script src="../highcharts/modules/data.js"></script>

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-license-checker/vaadin-license-checker.html">

<link rel="import" href="v-series.html">
<link rel="import" href="valo-theme.html">
<link rel="import" href="configuration-reader.html">

<!--
An element that provides a WebComponent interface for <a href="http://www.highcharts.com/">HighCharts</a>

Example:

    <v-chart type="line">
        <vc-title>Example</vc-title>
        <v-series name="Example">
            <vc-data>["Example1", 45.0], ["Example2", 26.8]</vc-data>
        </v-series>
    </v-chart>

Highcharts' Chart, Series and Point events are wrapped and thrown, event info is contained in details of CustomEvent
Event names can be checked in _chartEventNames, _seriesEventNames and _pointEventNames

<dom-module id="chart-click-listener">
    <template>
        <v-chart on-chart-click="clickListener">
            <vc-title>User supplied data</vc-title>
            <v-series>
                <vc-data>[20, 20], [80, 80]</vc-data>
            </v-series>
        </v-chart>
    </template>
    <script>
        Polymer({
            is: 'chart-click-listener',
            clickListener: function (e) {
                //get the Highcharts event with chart specific details
                var originalEvent = e.detail.originalEvent;
                // find the clicked values and the series
                var x = originalEvent.xAxis[0].value,
                    y = originalEvent.yAxis[0].value,
                    series = e.detail.chart.series[0];
                // Add it
                series.addPoint([x, y]);
            }
        });
    </script>
</dom-module>
-->
<dom-module id="v-chart">
    <template>
        <div id="chartContainer" style="height:100%; width:100%;"></div>
        <vaadin-license-checker product-name="vaadin-charts"
                                product-version="3"
                                product-caption="Vaadin Charts">

        </vaadin-license-checker>
    </template>
    <script>
        Polymer({
            is: 'v-chart',

            behaviors: [ValoThemeBehavior, ConfigurationReaderBehavior],

            /**
             * Fired when the chart has been fully loaded.
             *
             * @event chart-loaded
             */

            properties: {

                /**
                 * Highcharts JS object. Use this to configure the chart after creation.
                 **/
                chart: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },

                type: {
                    type: String,
                    value: 'line'
                },

                /* ----------- internal ----------- */

                /**
                 * Initial chart configuration before initial rendering.
                 **/
                _chartConf: {
                    type: Object,
                    value: function () {
                        return {chart: {}};
                    }
                }
            },

            /**
             *  Name of the chart events to add to the configuration and its corresponding event for v-chart
             **/
            _chartEventNames: {
                addSeries: "add-series",
                afterPrint: "after-print",
                beforePrint: "before-print",
                click: "chart-click",
                drilldown: "drilldown",
                drillup: "drillup",
                redraw: "redraw",
                selection: "selection"
            },
            /**
             *  Name of the series events to add to the configuration and its corresponding event for v-chart
             **/
            _seriesEventNames: {
                afterAnimate: "series-after-animate",
                checkboxClick: "series-checkbox-click",
                click: "series-click",
                hide: "series-hide",
                legendItemClick: "series-legend-item-click",
                mouseOut: "series-mouse-out",
                mouseOver: "series-mouse-over",
                show: "series-show"
            },
            /**
             *  Name of the point events to add to the configuration and its corresponding event for v-chart
             **/
            _pointEventNames: {
                click: "point-click",
                mouseOut: "point-mouse-out",
                mouseOver: "point-mouse-over",
                remove: "point-remove",
                select: "point-select",
                unselect: "point-unselect",
                update: "point-update"
            },

            /**
             * Reloads the chart with the original configuration defined in elements and its attributes.
             */
            reloadConfiguration: function () {
                this._chartConf = {chart: {}};
                this._initConfiguration();
                this.chart.destroy();
                this.chart = {};
                this._reloadSeries();
                this._initChart();
            },

            /**
             * Reload all the chart's series
             */
            _reloadSeries: function () {
                var series = Polymer.dom(this).querySelectorAll('v-series');
                for (var i = 0; i < series.length; i++) {
                    series[i]._reloadConfiguration();
                }
            },

            /**
             * Dynamically add a new Series to this chart
             * @return The index of the added series in the series array
             **/
            _addSeries: function (newSeries) {
                if (this._chartConf.series === undefined) {
                    this._chartConf.series = [];
                }
                this._chartConf.series.push(newSeries);
                return this._chartConf.series.length - 1;
            },

            /**
             * Dynamically add a new Series to this chart's Drilldown configuration
             * @return The index of the added series in the drilldown series array
             **/
            _addDrilldownSeries: function (newSeries) {
                if (!this._chartConf.drilldown) {
                    this._chartConf.drilldown = {};
                }
                if (!this._chartConf.drilldown.series) {
                    this._chartConf.drilldown.series = [];
                }
                this._chartConf.drilldown.series.push(newSeries);
                return this._chartConf.drilldown.series.length - 1;
            },

            /* ----------- lifecycle ----------- */
            created: function () {
                //Workaround to prevent _chartConf from being undefined when calling _addSeries from child component in FF
                this._chartConf = {};
            },

            attached: function () {
                this._initChart();
            },

            /**
             * Initializes the chart property using the json configuration.
             */
            _initChart: function () {
                //Only initialize once
                if (Object.keys(this.chart).length === 0) {
                    this.chart = new Highcharts.Chart(this._chartConf);
                    this.fire("chart-loaded");
                }
            },

            ready: function () {
                this._initConfiguration();

                if (this._loadTheme) {
                    this._loadTheme();
                }
            },

            /**
             * Initializes the chart json configuration.
             */
            _initConfiguration: function () {
                this._cleanNode(Polymer.dom(this));
                this._loadConfiguration(this._chartConf, Polymer.dom(this));

                if (!this._chartConf.chart) {
                    this._chartConf.chart = {};
                }

                this._initEventListeners();
                this._chartConf.chart.type = this.type;
                this._chartConf.chart.renderTo = this.$.chartContainer;
            },

            _initEventListeners: function () {
                this._chartConf.chart.events = {};
                for (var key in this._chartEventNames) {
                    if (this._chartEventNames.hasOwnProperty(key)) {
                        this._addChartEvent(key, this._chartEventNames[key]);
                    }
                }

                this._ensureObjectStructure(this._chartConf, "plotOptions.series");
                this._chartConf.plotOptions.series.events = {};
                for (var key in this._seriesEventNames) {
                    if (this._seriesEventNames.hasOwnProperty(key)) {
                        this._addSeriesEvent(key, this._seriesEventNames[key]);
                    }
                }

                this._ensureObjectStructure(this._chartConf, "plotOptions.series.point");
                this._chartConf.plotOptions.series.point.events = {};
                for (var key in this._pointEventNames) {
                    if (this._pointEventNames.hasOwnProperty(key)) {
                        this._addPointEvent(key, this._pointEventNames[key]);
                    }
                }
            },

            _addChartEvent: function (highchartsName, vaadinChartsName) {
                var self = this;
                this._chartConf.chart.events[highchartsName] = function (e) {
                    self.fire(vaadinChartsName, {originalEvent: e, chart: this});
                };
            },

            _addSeriesEvent: function (highchartsName, vaadinChartsName) {
                var self = this;
                this._chartConf.plotOptions.series.events[highchartsName] = function (e) {
                    self.fire(vaadinChartsName, {originalEvent: e, series: this});
                };
            },

            _addPointEvent: function (highchartsName, vaadinChartsName) {
                var self = this;
                this._chartConf.plotOptions.series.point.events[highchartsName] = function (e) {
                    self.fire(vaadinChartsName, {originalEvent: e, point: this});
                };
            }

        });
    </script>
</dom-module>
