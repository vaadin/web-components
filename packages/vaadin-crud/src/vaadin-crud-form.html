<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Commercial Vaadin Add-On License 3.0, available at http://vaadin.com/license/cval-3.
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-form-layout/src/vaadin-form-layout.html">
<link rel="import" href="../../vaadin-text-field/src/vaadin-text-field.html">

  <script>
    (function() {

      /**
       * `<vaadin-crud-form>` is a <vaadin-form-layout> which automatically can configures all its items based
       * on the JSON structure of the first item set.
       *
       * You cannot manually configure fields but you can still style the layout as it's described in
       * `<vaadin-form-layout>` [Documentation](https://vaadin.com/components/vaadin-form-layout/html-api/elements/Vaadin.FormLayoutElement)
       *
       * @memberof Vaadin
       */
      class CrudFormElement extends (class extends Vaadin.FormLayoutElement {}) {
        static get is() {
          return 'vaadin-crud-form';
        }

        static get properties() {
          return {
            /**
             * A RegExp used to exclude properties in the item that do not need
             * to be mapped to form fields.
             *
             * Default is not to exclude any property.
             */
            exclude: {
              type: RegExp,
              observer: '__onExcludeChange'
            },
            /**
             * The item being edited.
             */
            item: Object
          };
        }

        static get observers() {
          return ['__onItemChange(item)'];
        }

        /**
         * Autogenerate fields for edition based on the JSON structure of the object provided.
         *
         * If not already called, the method will be executed the first time an item is assigned.
         */
        configure(object) {
          this.innerHTML = '';
          this._fields = [];
          this.__createFields(this, object);
          this.notifyResize();
        }

        __onExcludeChange(exclude) {
          if (typeof exclude == 'string') {
            this.exclude = RegExp(exclude, 'i');
          }
        }

        __onItemChange(item) {
          if (!this._fields) {
            this.configure(item);
          }
        }

        __createField(parent, path, type) {
          const field = document.createElement('vaadin-text-field');
          field.label = this.__capitalize(path);
          field.path = path;
          field.required = true;
          parent.appendChild(field);
          this._fields.push(field);
          return field;
        }

        __createFields(parent, object, path) {
          if (typeof object === 'object') {
            Object.keys(object).forEach(prop => {
              if (this.exclude && this.exclude.test(prop)) {
                return;
              }
              const newPath = (path ? `${path}.` : '') + prop;
              if (typeof object[prop] === 'object') {
                this.__createFields(parent, object[prop], newPath);
              } else {
                this.__createField(parent, newPath);
              }
            });
            if (!this._fields.length) {
              this._fields = undefined;
            }
          }
        }

        __capitalize(path) {
          return path.toLowerCase().replace(/(^|[^\w])([a-z])/g, ($0, $1, $2) => ' ' + $2.toUpperCase()).trim();
        }
      }

      customElements.define(CrudFormElement.is, CrudFormElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.CrudFormElement = CrudFormElement;
    })();
  </script>
