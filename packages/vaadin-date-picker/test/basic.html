<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../test-fixture/test-fixture-mocha.js"></script>
  <script src="common.js"></script>

  <link rel="import" href="../vaadin-date-picker.html">
</head>

<body>

  <test-fixture id="datepicker">
    <template>
      <vaadin-date-picker></vaadin-date-picker>
    </template>
  </test-fixture>

  <script>
    describe('Basic features', function() {
      var datepicker;

      beforeEach(function() {
        datepicker = fixture('datepicker');
      });

      afterEach(function(done) {
        datepicker.async(done, 1);
      });

      it('should have default value', function() {
        expect(datepicker.value).to.equal('');
      });

      it('should notify value change', function() {
        var spy = sinon.spy();
        datepicker.addEventListener('value-changed', spy);
        datepicker.value = '2000-02-01';
        expect(spy.calledOnce).to.be.true;
      });

      it('should open with open call', function(done) {
        datepicker.addEventListener('iron-overlay-opened', function() {
          done();
        });
        datepicker.open();
      });

      it('should close with close call', function(done) {
        datepicker.addEventListener('iron-overlay-opened', function() {
          datepicker.close();
        });
        datepicker.addEventListener('iron-overlay-closed', function() {
          done();
        });
        datepicker.open();
      });

      it('should open on input tap', function(done) {
        datepicker.addEventListener('iron-overlay-opened', function() {
          done();
        });
        tap(datepicker.$.input);
      });

      it('should open on label tap', function(done) {
        datepicker.addEventListener('iron-overlay-opened', function() {
          done();
        });
        tap(datepicker.$.label);
      });

      it('should scroll to today by default', function(done) {
        var spy = sinon.spy(datepicker.$.overlay, 'scrollToDate');
        datepicker.addEventListener('iron-overlay-opened', function() {
          expect(monthsEqual(spy.firstCall.args[0], new Date())).to.be.true;
          done();
        });
        datepicker.open();
      });

      it('should scroll to initial position', function(done) {
        datepicker.initialPosition = '2016-01-01';
        var initialPositionDate = new Date(2016, 0, 1);

        var spy = sinon.spy(datepicker.$.overlay, 'scrollToDate');
        datepicker.addEventListener('iron-overlay-opened', function() {
          expect(spy.firstCall.args[0]).to.eql(initialPositionDate);
          done();
        });
        datepicker.open();
      });

      it('should scroll to selected value by default', function(done) {
        var spy = sinon.spy(datepicker.$.overlay, 'scrollToDate');
        datepicker.value = '2000-02-01';
        datepicker.addEventListener('iron-overlay-opened', function() {
          expect(monthsEqual(spy.firstCall.args[0], new Date(2000, 1, 1))).to.be.true;
          done();
        });
        datepicker.open();
      });

      it('should close on overlay date tap', function(done) {
        datepicker.addEventListener('iron-overlay-closed', function() {
          done();
        });
        datepicker.addEventListener('iron-overlay-opened', function() {
          Polymer.Base.fire('date-tap', {}, {
            bubbles: true,
            node: datepicker.$.overlay
          });
        });
        datepicker.open();
      });

      it('should not have label defined by default', function() {
        expect(datepicker.label).to.be.undefined;
      });

      it('label should be bound to label element', function() {
        datepicker.label = 'This is LABEL';
        expect(datepicker.$.label.innerHTML).to.eql('This is LABEL');
      });

      it('should clear the value', function() {
        datepicker.value = '2000-02-01';
        tap(datepicker.$.clear);
        expect(datepicker.value).to.equal('');
      });

      it('should format display correctly', function() {
        datepicker.value = '2000-02-01';
        expect(datepicker.$.input.bindValue).to.equal('2/1/2000');
        datepicker.value = '1999-12-31';
        expect(datepicker.$.input.bindValue).to.equal('12/31/1999');
      });

      it('should not show clear icon', function(done) {
        expect(datepicker.$.clear.clientHeight).to.equal(0);
        datepicker.value = '2000-02-01';
        expect(datepicker.$.clear.clientHeight).to.equal(0);
        datepicker.value = '';
        datepicker.addEventListener('iron-overlay-opened', function() {
          expect(datepicker.$.clear.clientHeight).to.equal(0);
          done();
        });
        datepicker.open();
      });

      it('should show clear icon', function(done) {
        datepicker.value = '2000-02-01';
        datepicker.addEventListener('iron-overlay-opened', function() {
          if (isFullscreen(datepicker)) {
            expect(datepicker.$.overlay.$.clear.clientHeight).not.to.equal(0);
          } else {
            expect(datepicker.$.clear.clientHeight).not.to.equal(0);
          }
          done();
        });
        datepicker.open();
      });

      it('should open by tapping the calendar icon', function(done) {
        tap(datepicker.$.calendar);
        datepicker.addEventListener('iron-overlay-opened', function() {
          done();
        });
      });

      describe('window scroll realign', function() {

        it('should realign on window scroll', function(done) {
          datepicker.open();
          datepicker.addEventListener('iron-overlay-opened', function() {
            var spy = sinon.spy(datepicker, '_onWindowScroll');
            Polymer.Base.fire('scroll', {}, {node: window});
            datepicker.async(function() {
              expect(spy.called).to.be.true;
              done();
            }, 1);
          });
        });

        it('should not realign on year/month scroll', function(done) {
          datepicker.open();
          datepicker.addEventListener('iron-overlay-opened', function() {
            var spy = sinon.spy(datepicker, '_onWindowScroll');
            datepicker.$.overlay.$.yearScroller.$.scroller.scrollTop += 100;
            datepicker.async(function() {
              expect(spy.called).to.be.false;
              done();
            }, 1);
          });
        });

      });

      describe('value property formats', function() {

        it('should accept ISO format', function() {
          var date = new Date(0, 1, 3);

          datepicker.value = '0000-02-03';
          date.setFullYear(0);
          expect(datepicker._selectedDate).to.eql(date);

          datepicker.value = '+010000-02-03';
          date.setFullYear(10000);
          expect(datepicker._selectedDate).to.eql(date);

          datepicker.value = '-010000-02-03';
          date.setFullYear(-10000);
          expect(datepicker._selectedDate).to.eql(date);
        });

        it('should not accept non-ISO formats', function() {
          datepicker.value = '03/02/01';
          expect(datepicker.value).to.equal('');
          expect(datepicker._selectedDate).to.be.null;

          datepicker.value = '2010/02/03';
          expect(datepicker.value).to.equal('');
          expect(datepicker._selectedDate).to.be.null;

          datepicker.value = '03/02/2010';
          expect(datepicker.value).to.equal('');
          expect(datepicker._selectedDate).to.be.null;

          datepicker.value = '3 Feb 2010';
          expect(datepicker.value).to.equal('');
          expect(datepicker._selectedDate).to.be.null;

          datepicker.value = 'Feb 3, 2010';
          expect(datepicker.value).to.equal('');
          expect(datepicker._selectedDate).to.be.null;
        });

        it('should output ISO format', function() {
          var date = new Date(0, 1, 3);

          date.setFullYear(0);
          datepicker._selectedDate = date;
          expect(datepicker.value).to.equal('0000-02-03');

          date.setFullYear(10000);
          datepicker._selectedDate = new Date(date.getTime());
          expect(datepicker.value).to.equal('+010000-02-03');

          date.setFullYear(-10000);
          datepicker._selectedDate = new Date(date.getTime());
          expect(datepicker.value).to.equal('-010000-02-03');
        });

      });
      describe('i18n', function() {
        beforeEach(function(done) {
          datepicker.set('i18n.weekdaysShort', 'su_ma_ti_ke_to_pe_la'.split('_'));
          datepicker.set('i18n.firstDayOfWeek', 1);
          datepicker.set('i18n.formatDate', function(d) {
            if (d) {
              return [d.getDate(), d.getMonth() + 1, d.getFullYear()].join('.');
            }
          });
          datepicker.async(done);
        });

        it('should notify i18n mutation to children', function() {
          var monthCalendar = datepicker.$.overlay.$.scroller.$.scroller.querySelector('vaadin-month-calendar');
          var weekdays = monthCalendar.$.monthGrid.querySelectorAll('div.weekday');
          var weekdayTitles = Array.prototype.map.call(weekdays, function(weekday) {
            return weekday.textContent;
          });
          expect(weekdayTitles).to.eql(['ma', 'ti', 'ke', 'to', 'pe', 'la', 'su']);
        });

        it('should reflect value in overlay label', function() {
          datepicker.value = '2000-02-01';
          expect(datepicker.$.overlay.$.input.value).to.equal('1.2.2000');
        });
      });

    });
  </script>

</body>

</html>
