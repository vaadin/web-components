<!--
@license
Copyright (c) 2016 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<!--

`vaadin-grid-selection-column` is a helper element for the `vaadin-grid` that provides default templates and functionality for the selection.
With it the user can select rows using checkboxes displayed in a column.

When the grid is configured with an array of items as the data source, it provides the feature of selecting all the items by clicking on the checkbox in the header.

-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="vaadin-grid-column.html">

<dom-module id="vaadin-grid-selection-column">
  <template>
    <template class="header" id="defaultHeaderTemplate">
      <input hidden$="[[_selectAllHidden]]" type="checkbox" on-click="_onSelectAll" checked="[[_isChecked(selectAll, _indeterminate)]]" indeterminate="[[_indeterminate]]"/>
    </template>
    <template>
      <input type="checkbox" checked="{{selected::change}}" />
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'vaadin-grid-selection-column',

    behaviors: [vaadin.elements.grid.ColumnBehavior],

    properties: {
      width: {
        type: String,
        value: '52px'
      },

      flex: {
        type: Number,
        value: 0
      },

      selectAll: {
        type: Boolean,
        value: false,
        notify: true
      },

      _grid: Object,

      _indeterminate: Boolean,

      _selectAllHidden: Boolean
    },

    observers: [
      '_onSelectAllChanged(selectAll, _grid)'
    ],

    detached: function() {
      if (this._grid) {
        this.unlisten(this._grid, 'data-source-changed', '_onDataSourceChanged');
        this.unlisten(this._grid, 'filter-changed', '_onSelectedItemsChanged');
        this.unlisten(this._grid, 'selected-items-changed', '_onSelectedItemsChanged');
      }
    },

    attached: function() {
      this._grid = this._findGrid(this);
      if (this._grid) {
        this.listen(this._grid, 'data-source-changed', '_onDataSourceChanged');
        this.listen(this._grid, 'filter-changed', '_onSelectedItemsChanged');
        this.listen(this._grid, 'selected-items-changed', '_onSelectedItemsChanged');
      }
    },

    _headerTemplateChanged: function(headerTemplate) {
      // needed to override the dataHost correctly in case internal template is used.
      var templatizer = new vaadin.elements.grid.Templatizer(headerTemplate === this.$.defaultHeaderTemplate ? this : this.dataHost);
      templatizer._instanceProps = {};
      templatizer.template = headerTemplate;

      this.fire('property-changed', {path: 'headerTemplate', value: headerTemplate});
    },

    _findGrid: function(elm) {
      while (elm && elm.localName != 'vaadin-grid') {
        elm = elm.parentElement;
      }
      return elm || undefined;
    },

    _selectFirstTemplate: function(selector) {
      return Polymer.dom(this).querySelectorAll(selector)[0]
          || Polymer.dom(this.root).querySelectorAll(selector)[0];
    },

    _onSelectAllChanged: function(selectAll, grid) {
      if (this._selectAllChangeLock) {
        return;
      }

      grid.selectedItems = selectAll && grid.items ? grid._filter(grid.items) : [];
    },

    // Return true if array `a` contains all the items in `b`
    // We need this when sorting or to preserve selection after filtering.
    _arrayContains: function(a, b) {
      for (var i = 0; a && b && b[i] && a.indexOf(b[i]) >= 0; i++);
      return i == b.length;
    },

    _onSelectAll: function(e) {
      this.selectAll = this._indeterminate || !this.selectAll;
    },

    // iOS needs indeterminated + checked at the same time
    _isChecked: function(selectAll, indeterminate) {
      return indeterminate || selectAll;
    },

    _onSelectedItemsChanged: function(e) {
      this._selectAllChangeLock = true;
      if (!this._grid.selectedItems.length) {
        this.selectAll = false;
        this._indeterminate = false;
      } else if (this._arrayContains(this._grid.selectedItems, this._grid._filter(this._grid.items))) {
        this.selectAll = true;
        this._indeterminate = false;
      } else {
        this.selectAll = false;
        this._indeterminate = true;
      }
      this._selectAllChangeLock = false;
    },

    _onDataSourceChanged: function(e) {
      this._selectAllHidden = !this._grid.items;
    }
  });
</script>
