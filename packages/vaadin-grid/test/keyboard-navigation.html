<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="helpers.html">
  <link rel="import" href="../vaadin-grid.html">
</head>

<body>
  <style is="custom-style">
    vaadin-grid {
      height: 500px;
      --vaadin-grid-body-cell: {
        padding: 0;
        height: 50px;
      }
    }
  </style>
  <test-fixture id="default">
    <template>
      <vaadin-grid>
        <vaadin-grid-column>
          <template class="header"></template>
          <template>[[index]] [[item]]</template>
          <template class="footer"></template>
        </vaadin-grid-column>
        <vaadin-grid-column>
          <template class="header">
            <input>
          </template>
          <template>
            <input>
          </template>
          <template class="footer">
            <input>
          </template>
        </vaadin-grid-column>
        <vaadin-grid-column>
          <template class="header"></template>
          <template>[[index]] [[item]]</template>
          <template class="footer"></template>
        </vaadin-grid-column>
      </vaadin-grid>
      <input id="focusable">
    </template>
  </test-fixture>

  <script>
    describe('keyboard navigation', function() {
      var grid, scroller, header, footer, body, headerTrap, bodyTrap, footerTrap;
      beforeEach(function() {
        grid = fixture('default')[0];
        grid.items = ['foo', 'bar'];

        scroller = grid.$.scroller;
        header = grid.$.scroller.$.header;
        body = grid.$.scroller.$.items;
        footer = grid.$.scroller.$.footer;

        // stubbing out focusing to make sure it works even if the browser
        // window doesn't have focus.
        headerTrap = grid.$.scroller.$.headerFocusTrap;
        sinon.stub(headerTrap, 'focus', function(e) {
          Polymer.Base.fire('focus', {}, {
            node: headerTrap
          });
        });

        bodyTrap = grid.$.scroller.$.bodyFocusTrap;
        sinon.stub(bodyTrap, 'focus', function(e) {
          Polymer.Base.fire('focus', {}, {
            node: bodyTrap
          });
        });

        footerTrap = grid.$.scroller.$.footerFocusTrap;
        sinon.stub(footerTrap, 'focus', function(e) {
          Polymer.Base.fire('focus', {}, {
            node: footerTrap
          });
        });
      });

      afterEach(function() {
        headerTrap.focus.restore();
        bodyTrap.focus.restore();
        footerTrap.focus.restore();
      });

      function clickItem(rowIndex) {
        return getFirstCell(rowIndex).click();
      }

      function getFirstCell(rowIndex) {
        return grid.$.scroller.$.items.children[rowIndex].children[0];
      }

      function clickFirstBodyInput(rowIndex) {
        var cell = grid.$.scroller.$.items.children[rowIndex].children[1];

        getCellContent(cell).children[0].click();

        Polymer.Base.fire('focus', {}, {
          node: getCellContent(cell).children[0]
        });
      }

      function tab() {
        var event = MockInteractions.keyDownOn(scroller, 9);
      }

      function shiftTab() {
        MockInteractions.keyDownOn(scroller, 9, 'shift');
      }

      function left() {
        MockInteractions.keyDownOn(scroller, 37);
      }

      function up() {
        MockInteractions.keyDownOn(scroller, 38);
      }

      function right() {
        MockInteractions.keyDownOn(scroller, 39);
      }

      function down() {
        MockInteractions.keyDownOn(scroller, 40);
      }

      function space() {
        MockInteractions.keyDownOn(scroller, 32);
      }

      function pageUp() {
        MockInteractions.keyDownOn(scroller, 33);
      }

      function pageDown() {
        MockInteractions.keyDownOn(scroller, 34);
      }

      function end() {
        MockInteractions.keyDownOn(scroller, 35);
      }

      function ctrlEnd() {
        MockInteractions.keyDownOn(scroller, 35, 'ctrl');
      }

      function home() {
        MockInteractions.keyDownOn(scroller, 36);
      }

      function ctrlHome() {
        MockInteractions.keyDownOn(scroller, 36, 'ctrl');
      }

      function getFirstHeaderCell() {
        return grid.$.scroller.$.header.rows[0].children[0];
      }

      function focusHeaderInput() {
        var cell = grid.$.scroller.$.header.rows[0].children[1];
        var contents = getCellContent(cell);

        contents.children[0].click();

        Polymer.Base.fire('focus', {}, {
          node: contents.children[0]
        });
      }

      function focusFooterInput() {
        var cell = grid.$.scroller.$.footer.rows[0].children[1];
        var contents = getCellContent(cell);

        contents.children[0].click();

        Polymer.Base.fire('focus', {}, {
          node: contents.children[0]
        });
      }

      function clickFirstHeaderCell() {
        getFirstHeaderCell().click();
      }

      function clickFirstFooterCell() {
        grid.$.scroller.$.footer.rows[0].children[0].click();
      }

      describe('navigation mode', function() {
        it('should not be in navigation mode by default', function() {
          expect(scroller.navigating).to.be.false;
        });

        it('should not enable navigation mode when cell is clicked', function() {
          clickFirstHeaderCell();

          expect(scroller.navigating).to.be.false;
        });

        it('should disable navigation mode when blurred', function() {
          scroller.navigating = true;

          scroller.fire('blur');

          expect(scroller.navigating).to.be.false;
        });

        it('should enable navigation mode when tabbed into header', function() {
          // simulating tabbing into header
          headerTrap.focus();

          expect(scroller.navigating).to.be.true;
        });

        it('should enable navigation mode when tabbed inside header', function() {
          clickFirstHeaderCell();

          tab();

          expect(scroller.navigating).to.be.true;
        });

        it('should enable navigation mode when tabbed into footer', function() {
          // simulating tabbing into header
          footerTrap.focus();

          expect(scroller.navigating).to.be.true;
        });

        it('should enable navigation mode when tabbed inside footer', function() {
          clickFirstFooterCell();

          tab();

          expect(scroller.navigating).to.be.true;
        });

        it('should disable navigation mode when cell content is focused', function() {
          scroller.navigating = true;

          focusHeaderInput();

          expect(scroller.navigating).to.be.false;
          expect(scroller._virtualFocus).to.eql(header);
        });

        it('should enable navigation mode when tabbed inside focused input in header', function() {
          focusHeaderInput();

          tab();

          expect(scroller.navigating).to.be.true;
          expect(scroller._virtualFocus).to.eql(header);
        });

        it('should enable navigation mode when tabbed inside focused input in body', function() {
          clickFirstBodyInput(0);

          tab();

          expect(scroller.navigating).to.be.true;
          expect(scroller._virtualFocus).to.eql(body);
        });

        it('should enable navigation mode when tabbed inside focused input in footer', function() {
          focusFooterInput();

          tab();

          expect(scroller.navigating).to.be.true;
          expect(scroller._virtualFocus).to.eql(footer);
        });

        it('should enable navigation mode when shift-tabbed inside focused input in header', function() {
          focusHeaderInput();

          shiftTab();

          expect(scroller.navigating).to.be.true;
          expect(scroller._virtualFocus).to.eql(header);
        });

        it('should enable navigation mode when shift-tabbed inside focused input in body', function() {
          clickFirstBodyInput(0);

          shiftTab();

          expect(scroller.navigating).to.be.true;
          expect(scroller._virtualFocus).to.eql(body);
        });

        it('should enable navigation mode when shift-tabbed inside focused input in footer', function() {
          focusFooterInput();

          shiftTab();

          expect(scroller.navigating).to.be.true;
          expect(scroller._virtualFocus).to.eql(footer);
        });

        it('should enable navigation mode with page down', function() {
          clickFirstBodyInput(0);

          pageDown();

          expect(scroller.navigating).to.be.true;
        });

        it('should enable navigation mode with page up', function() {
          clickFirstBodyInput(0);

          pageUp();

          expect(scroller.navigating).to.be.true;
        });

        it('should enable navigation mode with home', function() {
          clickFirstBodyInput(0);

          home();

          expect(scroller.navigating).to.be.true;
        });

        it('should enable navigation mode with end', function() {
          clickFirstBodyInput(0);

          end();

          expect(scroller.navigating).to.be.true;
        });
      });

      describe('navigating with tab', function() {
        beforeEach(function() {
          scroller.navigating = true;
        });

        it('should have a focus trap as the very first child', function() {
          expect(grid.tabIndex).not.to.eql(0);

          // header focus trap needs to be the first element in Shadow DOM.
          var trap = Polymer.dom(scroller.root).querySelector(':not(style)');

          expect(trap.tabIndex).to.eql(0);
        });

        it('should have a focus trap as the very last child', function() {
          // footer focus trap needs to be the last element in Light DOM.
          var trap = Polymer.Settings.useNativeShadow ? grid.lastElementChild : scroller.lastElementChild;

          expect(trap.tabIndex).to.eql(0);
        });

        it('should be possible to tab through grid', function() {
          // assuming grid has been tabbed into.
          headerTrap.focus();
          expect(scroller._virtualFocus).to.eql(header);

          tab(); // focus body
          tab(); // focus footer

          expect(footerTrap.focus.callCount).to.eql(1);

          tab(); // focus outside (only virtual focus moves in test)
          expect(scroller._virtualFocus).to.be.null;
        });

        it('should be possible to shift-tab back from body to header', function() {
          // assuming grid has been tabbed into.
          headerTrap.focus();

          tab(); // focus body
          shiftTab(); // focus header

          expect(headerTrap.focus.callCount).to.eql(2);
          expect(scroller._virtualFocus).to.eql(header);
        });

        it('should be possible to tab back from body to footer', function() {
          // assuming grid has been tabbed into.
          footerTrap.focus();

          shiftTab(); // focus body
          tab(); // focus footer

          expect(footerTrap.focus.callCount).to.eql(2);
          expect(scroller._virtualFocus).to.eql(footer);
        });

        it('should be possible to shift-tab through grid', function() {
          // assuming grid has been tabbed into.
          footerTrap.focus();
          expect(scroller._virtualFocus).to.eql(footer);

          shiftTab(); // focus body
          shiftTab(); // focus header

          expect(headerTrap.focus.callCount).to.eql(1);

          shiftTab(); // focus outside (only virtual focus moves in test)
          expect(scroller._virtualFocus).to.be.null;
        });

        it('should set virtual focus to header on header cell click', function() {
          clickFirstHeaderCell();

          expect(scroller._virtualFocus).to.eql(header);
        });

        it('should set virtual focus to body on body cell click', function() {
          clickItem(0);

          expect(scroller._virtualFocus).to.eql(body);
        });

        it('should set virtual focus to footer on footer cell click', function() {
          clickFirstFooterCell();

          expect(scroller._virtualFocus).to.eql(footer);
        });

        it('should move virtual focus from header to body on tab', function() {
          scroller._virtualFocus = header;

          tab();

          expect(scroller._virtualFocus).to.eql(body);
        });

        it('should move virtual focus from body to footer on tab', function() {
          scroller._virtualFocus = body;

          tab();

          expect(scroller._virtualFocus).to.eql(footer);
        });

        it('should move virtual focus from header to footer on tab', function() {
          scroller._virtualFocus = header;

          tab();
          tab();

          expect(scroller._virtualFocus).to.eql(footer);
        });

        it('should move virtual focus from footer to body on shift-tab', function() {
          scroller._virtualFocus = footer;

          shiftTab();

          expect(scroller._virtualFocus).to.eql(body);
        });

        it('should move virtual focus from body to header on shift-tab', function() {
          scroller._virtualFocus = body;

          shiftTab();

          expect(scroller._virtualFocus).to.eql(header);
        });

        it('should move actual focus to from footer to body on shift-tab', function() {
          scroller._virtualFocus = footer;

          shiftTab();
          shiftTab();

          expect(bodyTrap.focus.callCount).to.eql(1);
        });

        it('should move actual focus from input inside header to header on tab', function() {
          focusHeaderInput();

          tab();

          expect(scroller._virtualFocus).to.eql(header);
          expect(headerTrap.focus.callCount).to.eql(1);
        });

        it('should move actual focus from input inside header to header on shift-tab', function() {
          focusHeaderInput();

          shiftTab();

          expect(headerTrap.focus.callCount).to.eql(1);
        });

        it('should move actual focus from input inside body to body trap on tab', function() {
          clickFirstBodyInput(0);

          tab();

          expect(bodyTrap.focus.callCount).to.eql(1);
        });

        it('should move actual focus from input inside body to body trap on shift-tab', function() {
          clickFirstBodyInput(0);

          shiftTab();

          expect(bodyTrap.focus.callCount).to.eql(1);
        });

        it('should move actual focus from input inside footer to footer on tab', function() {
          focusFooterInput();

          tab();

          expect(footerTrap.focus.callCount).to.eql(1);
        });

        it('should move actual focus from input inside footer to footer on shift-tab', function() {
          focusFooterInput();

          shiftTab();

          expect(footerTrap.focus.callCount).to.eql(1);
        });

        it('should not move virtual focus from body to footer on tab when no footer rows exist', function() {
          footer.children[0].hidden = true;

          scroller._virtualFocus = body;

          tab();

          expect(scroller._virtualFocus).to.be.null;
        });

        it('should not move virtual focus to footer on shift-tab when no footer rows exist', function() {
          footer.children[0].hidden = true;
          footerTrap.focus();

          expect(scroller._virtualFocus).to.eql(body);
        });
      });

      describe('navigating with keys', function() {
        it('should enable navigation mode on down', function() {
          focusHeaderInput();

          down();

          expect(scroller.navigating).to.be.true;
        });

        it('should navigate on down when navigation mode is off', function() {
          clickFirstBodyInput(0);

          down();

          expect(scroller._virtualFocus._focusedRowIndex).to.eql(1);
        });

        it('should enable navigation mode on up', function() {
          focusHeaderInput();

          up();

          expect(scroller.navigating).to.be.true;
        });

        it('should navigate on up when navigation mode is off', function() {
          clickFirstBodyInput(1);

          up();

          expect(scroller._virtualFocus._focusedRowIndex).to.eql(0);
        });

        it('should enable navigation mode on left', function() {
          focusHeaderInput();

          left();

          expect(scroller.navigating).to.be.true;
        });

        it('should navigate on left when navigation mode is off', function() {
          clickFirstBodyInput(0);
          scroller._virtualFocus._focusedCellIndex = 1;

          left();

          expect(scroller._virtualFocus._focusedCellIndex).to.eql(0);
        });

        it('should enable navigation mode on right', function() {
          focusHeaderInput();

          right();

          expect(scroller.navigating).to.be.true;
        });

        it('should navigate on right when navigation mode is off', function() {
          clickFirstBodyInput(0);

          right();

          expect(scroller._virtualFocus._focusedCellIndex).to.eql(2);
        });

        it('should focus cell below with down', function() {
          clickFirstBodyInput(0);
          tab();

          down();

          expect(scroller._virtualFocus._focusedRowIndex).to.eql(1);
          expect(scroller._virtualFocus._focusedCellIndex).to.eql(1);
        });

        it('should focus cell above with up', function() {
          clickFirstBodyInput(0);
          down();

          up();

          expect(scroller._virtualFocus._focusedRowIndex).to.eql(0);
          expect(scroller._virtualFocus._focusedCellIndex).to.eql(1);
        });

        it('should focus cell left with left', function() {
          clickFirstBodyInput(0);

          left();

          expect(scroller._virtualFocus._focusedCellIndex).to.eql(0);
          expect(scroller._virtualFocus._focusedRowIndex).to.eql(0);
        });

        it('should focus cell right with right', function() {
          clickFirstBodyInput(0);
          left();

          right();

          expect(scroller._virtualFocus._focusedCellIndex).to.eql(1);
          expect(scroller._virtualFocus._focusedRowIndex).to.eql(0);
        });

        describe('with hidden columns', function() {
          it('should skip over hidden column with right arrow', function() {
            grid._columnTree[0][1].hidden = true;
            clickItem(0);

            right();

            expect(scroller._virtualFocus._focusedCellIndex).to.eql(2);
          });

          it('should skip over hidden column with left arrow', function() {
            grid._columnTree[0][1].hidden = true;
            clickItem(0);
            right();

            left();

            expect(scroller._virtualFocus._focusedCellIndex).to.eql(0);
          });

          it('should not navigate to hidden column with right arrow', function() {
            grid._columnTree[0][0].hidden = true;
            clickItem(0);

            left();

            expect(scroller._virtualFocus._focusedCellIndex).to.eql(1);
          });

          it('should not navigate to hidden column with right arrow', function() {
            grid._columnTree[0][2].hidden = true;
            clickItem(0);

            right();
            right();

            expect(scroller._virtualFocus._focusedCellIndex).to.eql(1);
          });

          it('should not navigate to hidden column with end', function() {
            grid._columnTree[0][0].hidden = true;
            clickItem(0);

            home();

            expect(scroller._virtualFocus._focusedCellIndex).to.eql(1);
          });

          it('should not navigate to hidden column with home', function() {
            grid._columnTree[0][2].hidden = true;
            clickItem(0);

            end();

            expect(scroller._virtualFocus._focusedCellIndex).to.eql(1);
          });
        });

        it('should focus first cell with home', function() {
          clickFirstBodyInput(0);
          right();

          home();

          expect(scroller._virtualFocus._focusedCellIndex).to.eql(0);
        });

        it('should focus first cell on first row with ctrl+home', function() {
          clickFirstBodyInput(0);
          right();

          ctrlHome();

          expect(scroller._virtualFocus._focusedCellIndex).to.eql(0);
          expect(scroller._virtualFocus._focusedRowIndex).to.eql(0);
        });

        it('should focus last cell with end', function() {
          clickFirstBodyInput(0);

          end();

          expect(scroller._virtualFocus._focusedCellIndex).to.eql(2);
        });


        it('should focus last cell on last row with ctrl+end', function() {
          clickFirstBodyInput(0);

          ctrlEnd();

          expect(scroller._virtualFocus._focusedCellIndex).to.eql(2);
          expect(scroller._virtualFocus._focusedRowIndex).to.eql(1);
        });

        describe('horizontal scrolling', function() {
          beforeEach(function() {
            grid.style.width = '100px'; // column default min width is 100px
          });

          it('should scroll cells visible with right arrow on header', function() {
            clickFirstHeaderCell();
            down();

            right();

            expect(grid.$.scroller.$.table.scrollLeft).to.be.at.least(100);
          });

          it('should scroll cells visible with right arrow on body', function() {
            clickItem(0);
            down();

            right();

            expect(grid.$.scroller.$.table.scrollLeft).to.be.at.least(100);
          });

          it('should scroll cells visible with right arrow on footer', function() {
            clickFirstFooterCell();
            down();

            right();

            expect(grid.$.scroller.$.table.scrollLeft).to.be.at.least(100);
          });

          it('should scroll cells visible with left arrow on header', function() {
            clickFirstHeaderCell();
            down();
            right();

            left();

            expect(grid.$.scroller.$.table.scrollLeft).to.eql(0);
          });

          it('should scroll cells visible with left arrow on body', function() {
            clickItem(0);
            down();
            right();

            left();

            expect(grid.$.scroller.$.table.scrollLeft).to.eql(0);
          });

          it('should scroll cells visible with home', function() {
            clickItem(0);
            grid.$.scroller.$.table.scrollLeft = 999999999;

            home();

            expect(grid.$.scroller.$.table.scrollLeft).to.eql(0);
          });

          it('should scroll cells visible with end', function() {
            clickItem(0);

            end();

            expect(grid.$.scroller.$.table.scrollLeft).to.eql(grid.$.scroller.$.table.scrollWidth - grid.$.scroller.$.table.clientWidth);
          });

          it('should scroll cell visible under from frozen cells with left arrow', function(done) {
            grid.style.width = '200px'; // column default min width is 100px
            grid.style.border = 'none';
            grid._columnTree[0][0].frozen = true;

            clickItem(0);
            right();
            right();

            grid.async(function() {
              left();
              expect(grid.$.scroller.$.table.scrollLeft).to.eql(0);
              done();
            });
          });

          it('should scroll cells visible with left arrow on footer', function() {
            clickFirstFooterCell();
            down();
            right();

            left();

            expect(grid.$.scroller.$.table.scrollLeft).to.eql(0);
          });
        });

        describe('vertical scrolling', function() {
          beforeEach(function() {
            grid.size = 200;
            grid.dataSource = infiniteDataSource;
          });

          it('should scroll rows visible with up arrow', function() {
            clickItem(0);
            grid.$.scroller.scrollToScaledIndex(100);

            up();

            expect(grid.$.scroller.$.table.scrollTop).to.eql(0);
          });

          it('should scroll rows visible with down arrow', function() {
            clickItem(grid.$.scroller.lastVisibleIndex);

            down();

            expect(grid.$.scroller.$.table.scrollTop).to.be.above(0);
          });

          it('should scroll to the first row with ctrl+home', function(done) {
            clickItem(0);
            grid.$.scroller.$.table.scrollTop = 9999999999;

            grid.async(function() {
              ctrlHome();

              expect(grid.$.scroller.$.table.scrollTop).to.eql(0);

              done();
            });
          });

          it('should scroll to the last row with ctrl+end', function() {
            clickItem(0);

            ctrlEnd();

            expect(grid.$.scroller.$.table.scrollTop).to.eql(grid.$.scroller.$.table.scrollHeight - grid.$.scroller.$.table.clientHeight);
          });

          it('should scroll down one page with page down', function() {
            clickItem(0);

            pageDown();

            // 9 items per page.
            expect(scroller._virtualFocus._focusedRowIndex).to.eql(0 + 9);
          });

          it('should scroll up one page with page up', function(done) {
            clickItem(0);
            pageDown();

            grid.async(function() {
              pageUp();

              expect(scroller._virtualFocus._focusedRowIndex).to.eql(0);
              done();
            });
          });

          it('should scroll the focused item visible when focus is set to body', function(done) {
            grid.$.scroller.$.table.scrollTop = 500;

            grid.async(function() {
              grid.$.scroller._virtualFocus = grid.$.scroller.$.items;

              expect(grid.$.scroller.$.table.scrollTop).to.eql(0);

              done();
            });
          });
        });
      });

      describe('activating items', function() {
        it('should activate on space', function() {
          clickFirstBodyInput(0);
          tab();

          space();

          expect(grid.activeItem).to.eql('foo');
        });

        it('should activate item another on space', function() {
          clickFirstBodyInput(0);
          tab();

          space();

          down();
          space();

          expect(grid.activeItem).to.eql('bar');
        });

        it('should deactive item on space', function() {
          clickFirstBodyInput(0);
          tab();

          space();
          space();

          expect(grid.activeItem).to.be.null;
        });

        it('should not have a default value', function() {
          expect(grid.activeItem).to.be.undefined;
        });

        it('should activate on click', function() {
          clickItem(0);

          expect(grid.activeItem).to.eql('foo');
        });

        it('should activate another on click', function() {
          clickItem(0);

          clickItem(1);

          expect(grid.activeItem).to.eql('bar');
        });

        it('should deactive on click', function() {
          clickItem(0);

          clickItem(0);

          expect(grid.activeItem).to.be.null;
        });

        it('should not activate when clicking on a native input', function() {
          clickFirstBodyInput(0);

          expect(grid.activeItem).to.be.undefined;
        });
      });

      describe('keyboard focus', function() {
        it('should have focused first cell in header by default', function() {
          expect(header.hasAttribute('focused')).to.be.false;

          scroller._virtualFocus = header;

          var firstRow = header.children[0];
          expect(firstRow.hasAttribute('focused')).to.be.true;

          var firstCell = firstRow.children[0];
          expect(firstCell.hasAttribute('focused')).to.be.true;
        });

        it('should have focused first cell in body by default', function() {
          expect(body.hasAttribute('focused')).to.be.false;

          scroller._virtualFocus = body;

          var firstRow = body.children[0];
          expect(firstRow.hasAttribute('focused')).to.be.true;

          var firstCell = firstRow.children[0];
          expect(firstCell.hasAttribute('focused')).to.be.true;
        });

        it('should have focused first cell in footer by default', function() {
          expect(footer.hasAttribute('focused')).to.be.false;

          scroller._virtualFocus = footer;

          var firstRow = footer.children[0];
          expect(firstRow.hasAttribute('focused')).to.be.true;

          var firstCell = firstRow.children[0];
          expect(firstCell.hasAttribute('focused')).to.be.true;
        });

        it('should focus on click', function() {
          clickItem(1);

          var cell = getFirstCell(1);
          var row = cell.parentElement;
          var container = row.parentElement;

          expect(cell.hasAttribute('focused')).to.eql.true;
          expect(row.hasAttribute('focused')).to.eql.true;
          expect(container.hasAttribute('focused')).to.eql.true;
        });
      });
    });
  </script>

</body>

</html>
