
<link rel="import" href="../polymer/polymer.html">


<link rel="import" href="vaadin-grid-cell-click-behavior.html">

<dom-module id="vaadin-grid-table-cell"></dom-module>
<dom-module id="vaadin-grid-table-header-cell"></dom-module>
<dom-module id="vaadin-grid-table-footer-cell"></dom-module>
<dom-module id="vaadin-grid-sizer-cell"></dom-module>

<script>
  (function() {

    /**
     * @polymerBehavior vaadinGridTableCellBehavior
     */
    var vaadinGridTableCellBehavior = {
      properties: {
        column: Object,
        expanded: Boolean,
        flexGrow: Number,
        focused: {
          type: Boolean,
          reflectToAttribute: true
        },
        frozen: {
          type: Boolean,
          reflectToAttribute: true
        },
        lastFrozen: {
          type: Boolean,
          reflectToAttribute: true
        },
        hidden: {
          type: Boolean,
          reflectToAttribute: true
        },
        instance: Object,
        index: Number,
        item: Object,
        selected: Boolean,
        template: Object,
        target: Object,
        width: String,
        order: Number,
        reorderStatus: {
          type: String,
          reflectToAttribute: true
        },

        _childColumns: Array,

        _cellContent: Object,
        _insertionPoint: Object,
        _templatizer: Object
      },

      observers: ['_columnChanged(column)',
        '_cellAttached(column, isAttached)',
        '_expandedChanged(expanded, instance)',
        '_flexGrowChanged(flexGrow)',
        '_indexChanged(index, instance)',
        '_itemChanged(item, instance)',
        '_instanceChanged(instance, target)',
        '_selectedChanged(selected, instance)',
        '_toggleContent(isAttached, _cellContent, _insertionPoint)',
        '_toggleInstance(isAttached, _templatizer, instance)',
        '_widthChanged(width)',
        '_orderChanged(order)',
        '_visibleChildColumnsChanged(_visibleChildColumns)',
        '_childColumnsChanged(_childColumns)'
      ],

      created: function() {
        this.classList.add('vaadin-grid-cell');
      },

      _columnChanged: function(column) {
        this.flexGrow = column.flexGrow;
        this.frozen = column.frozen;
        this.lastFrozen = column._lastFrozen;
        this.headerTemplate = column.headerTemplate;
        this.footerTemplate = column.footerTemplate;
        this.template = column.template;
        this.width = column.width;
        this.hidden = column.hidden;
        this.resizable = column.resizable;
        this._childColumns = column._childColumns;
        this.order = column._order;

        // Assigning undefined to element.colSpan will set colSpan attribute to 0
        if (column.colSpan) {
          this.setAttribute('colspan', column.colSpan);
        }

        this.listen(column, 'property-changed', '_columnPropChanged');
      },

      _cellAttached: function(column, isAttached) {
        // Cells get detached when the column tree changes and new cells are created.
        // Also, cells get detached and attached during row reordering after scrolling.
        if (isAttached) {
          this.listen(column, 'property-changed', '_columnPropChanged');
        } else {
          this.unlisten(column, 'property-changed', '_columnPropChanged');
        }
      },

      _columnPropChanged: function(e) {
        if (e.target == this.column) {
          if (e.detail.path === 'colSpan') {
            this.setAttribute('colspan', e.detail.value);
          } else {
            this[e.detail.path] = e.detail.value;
          }
        }
      },

      _expandedChanged: function(expanded, instance) {
        instance.__expanded__ = expanded;
        instance.expanded = expanded;
      },

      _flexGrowChanged: function(flexGrow) {
        this.style.flexGrow = flexGrow;
      },

      _indexChanged: function(index, instance) {
        instance.index = index;
      },

      _itemChanged: function(item, instance) {
        instance.item = item;
      },

      _selectedChanged: function(selected, instance) {
        instance.__selected__ = selected;
        instance.selected = selected;
      },

      _childColumnsChanged: function(childColumns) {
        this.setAttribute('colspan', childColumns.length);
      },

      _toggleContent: function(isAttached, cellContent, insertionPoint) {
        if (isAttached) {
          if (Polymer.dom(cellContent).parentNode !== this.target) {
            Polymer.dom(this.target).appendChild(cellContent);
          }
          Polymer.dom(this).appendChild(insertionPoint);
        } else {
          this.debounce('remove-content', function() {
            if (!this.isAttached && Polymer.dom(cellContent).parentNode === this.target) {
              Polymer.dom(this.target).removeChild(cellContent);
            }
          }, 1);
        }
      },

      _toggleInstance: function(isAttached, templatizer, instance) {
        if (isAttached) {
          templatizer.addInstance(instance);
        } else {
          templatizer.removeInstance(instance);
        }
      },

      _widthChanged: function(width) {
        this.style.width = width;
      },

      _orderChanged: function(order) {
        this.style.order = order;
      },

      _templateChanged: function(template) {
        this.instance = template.templatizer.createInstance();
        this._templatizer = template.templatizer;
      },

      _instanceChanged: function(instance, target) {
        this.style.height = '';

        this._cellContent = document.createElement('div');

        this._cellContent.setAttribute('class', 'cell-content');
        var contentId = vaadin.elements.grid._contentIndex = vaadin.elements.grid._contentIndex + 1 || 0;
        this._cellContent.setAttribute('data-cell-content-id', contentId);
        // TODO: maybe change data-cell-content-id attribute to ID with a prefix?
        this._cellContent.setAttribute('id', 'vaadin-grid-cell-content-' + contentId);

        Polymer.dom(this._cellContent).appendChild(this.instance.root);

        this._insertionPoint = document.createElement('content');
        this._insertionPoint.setAttribute('select', '[data-cell-content-id="' + contentId + '"]');
      },
    };

    Polymer({
      is: 'vaadin-grid-table-cell',

      extends: 'td',

      behaviors: [
        vaadinGridTableCellBehavior,
        vaadin.elements.grid.CellClickBehavior
      ],

      observers: ['_templateChanged(template)'],

      _cellClick: function() {
        this.fire('cell-activate', {
          model: this.instance
        });
      }
    });

    Polymer({
      is: 'vaadin-grid-table-header-cell',

      extends: 'th',

      properties: {
        headerTemplate: Object,

        resizable: Boolean,

        columnResizing: {
          type: Boolean,
          reflectToAttribute: true
        }
      },

      behaviors: [
        vaadinGridTableCellBehavior,
        vaadin.elements.grid.CellClickBehavior
      ],

      observers: [
        '_headerTemplateChanged(headerTemplate, isAttached)',
        '_resizableChanged(resizable)'
      ],

      listeners: {
        'track': '_onTrack',
        'mousedown': '_cancelMouseDownOnResize',
        'mousemove': '_enableDrag',
        'mouseout': '_disableDrag'
      },

      _enableDrag: function() {
        // Text inside draggable grid cells can't be selected. Thus we need to
        // check the global selection state here to avoid a cell becoming
        // draggable while text is being selected.
        this._cellContent.draggable = this.target.columnReorderingAllowed && !window.getSelection().toString();
      },

      _disableDrag: function() {
        this._cellContent.draggable = false;
      },

      _cancelMouseDownOnResize: function(e) {
        if (e.target === this._resizeHandle) {
          e.preventDefault();
        }
      },

      _resizableChanged: function(resizable) {
        if (resizable) {
          this._resizeHandle = document.createElement('div');
          this._resizeHandle.classList.add('vaadin-grid-column-resize-handle');
          Polymer.dom(this).appendChild(this._resizeHandle);
        } else if (this._resizeHandle) {
          Polymer.dom(this).removeChild(this._resizeHandle);
        }
      },

      _onTrack: function(e) {
        if (e.target === this._resizeHandle) {
          this.columnResizing = true;

          // Get the target column to resize
          var column = this.column;
          if (column.localName === 'vaadin-grid-column-group') {
            column = column._childColumns.slice(0)
            .sort(function(a, b) {
              return a._order - b._order;
            })
            .pop();
          }
          var targetCell = this._getHeaderCellByColumn(column);

          // Resize the target column
          if (targetCell.offsetWidth) {
            var style = window.getComputedStyle(targetCell._cellContent);
            var minWidth = 10 + parseInt(style.paddingLeft) + parseInt(style.paddingRight);
            column.width = Math.max(minWidth, targetCell.offsetWidth + e.detail.x - targetCell.getBoundingClientRect().right) + 'px';
            column.flexGrow = 0;
          }

          // Fix width and flex-grow for all preceding columns
          var thead = this.parentElement.parentElement;
          Polymer.dom(thead).querySelectorAll('tr:last-child th')
          .sort(function(a, b) {
            return a.column._order - b.column._order;
          })
          .forEach(function(cell, index, array) {
            if (index < array.indexOf(targetCell)) {
              cell.column.width = cell.offsetWidth + 'px';
              cell.column.flexGrow = 0;
            }
          });
        }

        if (this.columnResizing && e.detail.state === 'end') {
          this.columnResizing = false;
        }
      },

      _getHeaderCellByColumn: function(column) {
        var thead = this.parentElement.parentElement;
        return Polymer.dom(thead).querySelectorAll('tr:last-child th').filter(function(cell) {
          return cell.column === column;
        })[0];
      },

      _headerTemplateChanged: function(headerTemplate, isAttached) {
        if (headerTemplate !== null && (this._isColumnRow || this.column.localName === 'vaadin-grid-column-group')) {
          this._isEmpty = false;
          this.instance = this.instance || headerTemplate.templatizer.createInstance();
          this._templatizer = headerTemplate.templatizer;
        } else {
          this._isEmpty = true;
          this.instance = this.instance || {root: document.createElement('div')};
        }

        // Safari 9 doesn't bubble events while not attached to the DOM. #552
        if (isAttached) {
          this.fire('cell-empty-changed');
        }
      }
    });

    Polymer({
      is: 'vaadin-grid-table-footer-cell',

      extends: 'td',

      properties: {
        footerTemplate: Object
      },

      behaviors: [
        vaadinGridTableCellBehavior,
        vaadin.elements.grid.CellClickBehavior
      ],

      observers: ['_footerTemplateChanged(footerTemplate, isAttached)'],

      _footerTemplateChanged: function(footerTemplate, isAttached) {
        if (footerTemplate !== null && (this._isColumnRow || this.column.localName === 'vaadin-grid-column-group')) {
          this._isEmpty = false;
          this.instance = this.instance || footerTemplate.templatizer.createInstance();
          this._templatizer = footerTemplate.templatizer;
        } else {
          this._isEmpty = true;
          this.instance = this.instance || {root: document.createElement('div')};
        }

        // Safari 9 doesn't bubble events while not attached to the DOM. #552
        if (isAttached) {
          this.fire('cell-empty-changed');
        }
      }
    });

    Polymer({
      is: 'vaadin-grid-sizer-cell',

      behaviors: [vaadinGridTableCellBehavior]
    });
  })();
</script>
