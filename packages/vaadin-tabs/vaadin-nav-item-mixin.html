<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/polymer.html">

<script>
  window.Vaadin = window.Vaadin || {};

  /**
   * A mixin providing `focused`, `focus-ring`, `active`, `disabled` and `selected`.
   *
   * `focused`, `active` and `focus-ring` are set as only as attributes.
   * @polymerMixin
   */
  Vaadin.NavItemMixin = superClass => class VaadinItemMixin extends superClass {
    static get properties() {
      return {
        /**
         * If true, the user cannot interact with this element.
         */
        disabled: {
          type: Boolean,
          value: false,
          notify: true,
          observer: '_disabledChanged',
          reflectToAttribute: true
        },
        /**
         * If true, the button is in the selected state.
         */
        selected: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true,
          observer: '_selectedChanged'
        }
      };
    }

    ready() {
      super.ready();
      this.addEventListener('focus', e => this._setFocused(true), true);
      this.addEventListener('blur', e => this._setFocused(false), true);
      this.addEventListener('mousedown', e => this._setActive(this._mousedown = true));
      this.addEventListener('mouseup', e => this._setActive(this._mousedown = false));
      this.addEventListener('keydown', e => this._onKeydown(e));
      this.addEventListener('keyup', e => this._onKeyup());
      this.addEventListener('click', e => this._toggle());
      if (!this.hasAttribute('tabindex')) {
        this.tabIndex = 0;
      }
    }

    _toggle() {
      const val = !this.selected;
      const evt = new CustomEvent('selected', {bubbles: true, cancelable: true, composed: true, detail: val});
      this.dispatchEvent(evt);
      if (!evt.defaultPrevented) {
        this.selected = val;
      }
    }

    _selectedChanged(selected) {
      this.setAttribute('aria-selected', selected);
    }

    _disabledChanged(disabled) {
      this.setAttribute('aria-disabled', disabled);
      this.style.pointerEvents = disabled ? 'none' : '';
      if (disabled) {
        this._oldTabIndex = this.tabIndex < 0 ? 0 : this.tabIndex;
        this._setFocused(false);
        this.tabIndex = -1;
        this.blur();
      } else if (this._oldTabIndex !== undefined) {
        this.tabIndex = this._oldTabIndex;
        delete this._oldTabIndex;
      }
    }

    _setFocused(focused) {
      if (focused) {
        this.setAttribute('focused', '');
        if (!this._mousedown) {
          this.setAttribute('focus-ring', '');
        }
      } else {
        this.removeAttribute('focused');
        this.removeAttribute('focus-ring');
        this._setActive(false);
      }
    }

    _setActive(active) {
      if (active) {
        this.setAttribute('active', '');
      } else {
        this.removeAttribute('active');
      }
    }

    _onKeydown(event) {
      if (/^( |SpaceBar|Enter)$/i.test(event.key)) {
        event.preventDefault();
        this._setActive(true);
      }
    }

    _onKeyup() {
      if (this.hasAttribute('active')) {
        this._setActive(false);
        this._toggle();
      }
    }
  };
</script>
