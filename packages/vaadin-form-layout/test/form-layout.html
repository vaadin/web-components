<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-form-layout tests</title>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../vaadin-form-layout.html">
</head>

<body>
  <test-fixture id="default">
    <template>
      <vaadin-form-layout>
        <vaadin-text-field></vaadin-text-field>
        <paper-input></paper-input>
        <vaadin-form-item></vaadin-form-item>
      </vaadin-form-layout>
    </template>
  </test-fixture>

  <test-fixture id="colspan">
    <template>
      <vaadin-form-layout columns="3">
        <vaadin-text-field></vaadin-text-field>
        <vaadin-text-field colspan="1"></vaadin-text-field>
        <vaadin-text-field colspan="2"></vaadin-text-field>
        <vaadin-text-field colspan="3"></vaadin-text-field>
        <vaadin-text-field colspan="4"></vaadin-text-field>
        <vaadin-text-field colspan="non-number"></vaadin-text-field>
      </vaadin-form-layout>
    </template>
  </test-fixture>

  <script>
    function getParsedWidth(el) {
      var width = el.style.getPropertyValue('width');
      var components = width.replace(/^calc\((.*)\)$/, '$1').split(' - ');
      return {
        percentage: components[0],
        gap: components[1]
      };
    }

    describe('basic features', function() {
      var layout, slot;

      beforeEach(function() {
        layout = fixture('default');
        slot = layout.shadowRoot.querySelector('slot');
      });

      it('should have slot', function() {
        expect(slot).to.be.ok;
      });

      it('should distribute vaadin-text-field', function() {
        var vaadinTextField = layout.querySelector('vaadin-text-field');
        expect(vaadinTextField).to.be.ok;
        expect(slot.assignedNodes()).to.contain(vaadinTextField);
      });

      it('should distribute paper-input', function() {
        var paperInput = layout.querySelector('paper-input');
        expect(paperInput).to.be.ok;
        expect(slot.assignedNodes()).to.contain(paperInput);
      });
    });

    describe('columns property', function() {
      var layout;

      beforeEach(function() {
        layout = fixture('default');
      });

      it('should have default value', function() {
        expect(layout.columns).to.equal('1 labels-on-top, 20em 1, 40em 2');
      });

      it('should assign width inline style on items', function() {
        layout.columns = 3;

        var parsedWidth = getParsedWidth(layout.firstElementChild);
        expect(parsedWidth.percentage).to.match(/%$/);
        expect(parseFloat(parsedWidth.percentage)).to.be.closeTo(33, .5);
      });

      it('should set label-on-top attribute to child form-item elements', function() {
        layout.columns = '1';

        expect(layout.children[0].getAttribute('label-on-top')).to.be.null;
        expect(layout.children[1].getAttribute('label-on-top')).to.be.null;
        expect(layout.children[2].getAttribute('label-on-top')).to.be.null;

        layout.columns = '1 labels-on-top';

        expect(layout.children[0].getAttribute('label-on-top')).to.be.null;
        expect(layout.children[1].getAttribute('label-on-top')).to.be.null;
        expect(layout.children[2].getAttribute('label-on-top')).to.equal('');
      });

      describe('responsive', function() {
        beforeEach(function() {
          document.body.style.minWidth = '0';
        });

        afterEach(function() {
          document.body.style.removeProperty('width');
          document.body.style.removeProperty('min-width');
        });

        function estimateEffectiveColumnCount(layout) {
          return 100 / parseFloat(getParsedWidth(layout.firstElementChild).percentage);
        }

        it('should be responsive by default', function() {
          document.body.style.width = '10em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(1, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.equal('');

          document.body.style.width = '20em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(1, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.be.null;

          document.body.style.width = '40em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(2, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.be.null;
        });

        it('should allow specifying non-responsive', function() {
          layout.columns = '3';

          document.body.style.width = '10em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(3, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.be.null;

          document.body.style.width = '20em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(3, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.be.null;

          document.body.style.width = '40em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(3, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.be.null;
        });

        it('should allow specifying more steps', function() {
          layout.columns = '1, 20em 2 labels-on-top, 40em 5';

          document.body.style.width = '10em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(1, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.be.null;

          document.body.style.width = '20em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(2, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.equal('');

          document.body.style.width = '40em';
          layout.dispatchEvent(new CustomEvent('iron-resize'));
          expect(estimateEffectiveColumnCount(layout)).to.be.closeTo(5, .1);
          expect(layout.children[2].getAttribute('label-on-top')).to.be.null;
        });
      });
    });

    describe('CSS properties', function() {
      var layout;

      function getCustomCSSPropertyValue(element, propertyName) {
        return window.ShadyCSS
          ? window.ShadyCSS.getComputedStyleValue(element, propertyName)
          : getComputedStyle(element).getPropertyValue(propertyName);
      }

      beforeEach(function() {
        layout = fixture('default');
      });

      it('should apply default column-gap', function() {
        expect(getParsedWidth(layout.firstElementChild).gap).to.equal('2em');
        expect(getComputedStyle(layout.firstElementChild).getPropertyValue('margin-left')).to.equal('16px'); // 0.5 * 2em in px
        expect(getComputedStyle(layout.firstElementChild).getPropertyValue('margin-right')).to.equal('16px');
      });

      it('should compensate for column-gap in layout wrapper', function() {
        expect(getComputedStyle(layout.$.layout).getPropertyValue('margin-left')).to.equal('-16px'); // -0.5 * 2em in px
        expect(getComputedStyle(layout.$.layout).getPropertyValue('margin-right')).to.equal('-16px');
      });

      it('should support updating with `updateStyles` call', function() {
        layout.updateStyles({
          '--vaadin-form-layout-column-gap': '2cm',
          '--vaadin-form-layout-label-width': '4cm',
          '--vaadin-form-layout-label-gap': '1cm'
        });
        expect(getParsedWidth(layout.firstElementChild).gap).to.equal('2cm');
        expect(getCustomCSSPropertyValue(layout, '--vaadin-form-layout-label-width')).to.equal('4cm');
        expect(getCustomCSSPropertyValue(layout, '--vaadin-form-layout-label-gap')).to.equal('1cm');
      });
    });

    describe('colspan', function() {
      var layout;

      beforeEach(function() {
        layout = fixture('colspan');
      });

      function estimateEffectiveColspan(el) {
        return parseFloat(getParsedWidth(el).percentage) / (100 / 3);
      }

      it('should span children correctly', function() {
        // empty means 1
        expect(estimateEffectiveColspan(layout.children[0])).to.be.closeTo(1, .1);

        // correct values
        expect(estimateEffectiveColspan(layout.children[1])).to.be.closeTo(1, .1);
        expect(estimateEffectiveColspan(layout.children[2])).to.be.closeTo(2, .1);
        expect(estimateEffectiveColspan(layout.children[3])).to.be.closeTo(3, .1);

        // if more then a number of columns, use number of columns
        expect(estimateEffectiveColspan(layout.children[4])).to.be.closeTo(3, .1);

        // invalid means 1
        expect(estimateEffectiveColspan(layout.children[5])).to.be.closeTo(1, .1);
      });
    });
  </script>
</body>
