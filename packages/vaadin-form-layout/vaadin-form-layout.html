<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../vaadin-themable-mixin/vaadin-themable-mixin.html">

<dom-module id="vaadin-form-layout">
  <template>
    <style>
      :host {
        display: block;

        /* CSS API for host */
        --vaadin-form-layout-column-gap: 2em; /* (default) */
      }

      #layout {
        display: flex;

        align-items: baseline; /* default `stretch` is not appropriate */

        flex-wrap: wrap; /* the items should wrap */

        /*
          To implement the column gap, horizontal margins for the items is used,
          see slotted elements style below. We need to compensate item margins
          in the wrapper, so that the are no gaps around the layout itself.
        */
        margin-left: calc(-0.5 * var(--vaadin-form-layout-column-gap));
        margin-right: calc(-0.5 * var(--vaadin-form-layout-column-gap));
      }

      #layout ::slotted(*) {
        /* Items should neigher grow nor shrink. */
        flex-grow: 0;
        flex-shrink: 0;

        /* Margins make gaps between the columns */
        margin-left: calc(0.5 * var(--vaadin-form-layout-column-gap));
        margin-right: calc(0.5 * var(--vaadin-form-layout-column-gap));
      }

      #layout ::slotted(br) {
        /*
          Line break element wraps the following item on a new line. Makes
          a block with zero height, stretched to fill all the available width
          of layout, so that the next sibling item is wrapped for sure.
        */
        display: block;
        content: '';
        flex: 1 1 100%;
        width: 9999px; /* for Firefox :-( */
      }
    </style>
    <div id="layout">
      <slot id="slot"></slot>
    </div>
  </template>

  <script>
    (function() {
      /**
       * `<vaadin-form-layout>` is a Polymer element providing configurable responsive
       * layout for form elements.
       *
       * ```html
       * <vaadin-form-layout>
       *
       *   <vaadin-form-item>
       *     <label slot="label">First Name</label>
       *     <input class="full-width" value="Jane">
       *   </vaadin-form-item>
       *
       *   <vaadin-form-item>
       *     <label slot="label">Last Name</label>
       *     <input class="full-width" value="Doe">
       *   </vaadin-form-item>
       *
       *   <vaadin-form-item>
       *     <label slot="label">Email</label>
       *     <input class="full-width" value="jane.doe@example.com">
       *   </vaadin-form-item>
       *
       * </vaadin-form-layout>
       * ```
       *
       * It supports any child elements as layout items.
       *
       * By default, it makes a layout of two columns if the element width is equal or
       * wider than 40em, and a single column layout otherwise.
       *
       * The number of columns and the responsive behavior are customizable with
       * the `columns` property.
       *
       * ### Spanning Items on Multiple Columns
       *
       * You can use `colspan` attribute on the items.
       * In the example below, the first text field spans on two columns:
       *
       * ```html
       * <vaadin-form-layout>
       *
       *   <vaadin-form-item colspan="2">
       *     <label slot="label">Address</label>
       *     <input class="full-width">
       *   </vaadin-form-item>
       *
       *   <vaadin-form-item>
       *     <label slot="label">First Name</label>
       *     <input class="full-width" value="Jane">
       *   </vaadin-form-item>
       *
       *   <vaadin-form-item>
       *     <label slot="label">Last Name</label>
       *     <input class="full-width" value="Doe">
       *   </vaadin-form-item>
       *
       * </vaadin-form-layout>
       * ```
       *
       * ### Explicit New Row
       *
       * Use the `<br>` line break element to wrap the items on a new row:
       *
       * ```html
       * <vaadin-form-layout>
       *
       *   <vaadin-form-item>
       *     <label slot="label">Email</label>
       *     <input class="full-width">
       *   </vaadin-form-item>
       *
       *   <br>
       *
       *   <vaadin-form-item>
       *     <label slot="label">Confirm Email</label>
       *     <input class="full-width">
       *   </vaadin-form-item>
       *
       * </vaadin-form-layout>
       * ```
       *
       * ### CSS Properties Reference
       *
       * The following custom CSS properties are available on the `<vaadin-form-layout>`
       * element:
       *
       * Custom CSS property | Description | Default
       * ---|---|---
       * `--vaadin-form-layout-column-gap` | Length of the gap between columns | `2em`
       *
       * @memberof Vaadin
       * @mixes Vaadin.ThemableMixin
       * @demo demo/index.html
       */
      class FormLayoutElement extends
          Vaadin.ThemableMixin(
              Polymer.mixinBehaviors(
                  [Polymer.IronResizableBehavior],
                  Polymer.Element
              )
          ) {
        static get is() {
          return 'vaadin-form-layout';
        }

        static get properties() {
          return {
            /**
             * Number of columns in the layout. Allows specifying a responsive
             * behavior with the number of columns and the label position
             * depending on the layout width.
             *
             * The value is a comma-separated list of one or more responsive
             * steps, each responsive step is a space-separated list of the
             * optional min-width threshold, the column count, and the optional
             * `labels-on-top` flag.
             *
             * The min-width thresholds are CSS length values specifying the
             * minimum width of the layout for each responsive step.
             *
             * #### Formal syntax
             *
             *     <responsive-step> [ , <responsive-step> ]*
             *
             *     <responsive-step> =
             *         [ <min-width> ]? <column-count> [ labels-on-top ]?
             *
             * where:
             *
             * <dl>
             *   <dt>`<min-width> = <length>`</dt>
             *   <dd>
             *     Minimum width of the layout corresponding to this step.
             *     Optional, assumed as 0 if omitted.
             *   </dd>
             *
             *   <dt>`<column-count> = <integer>`</dt>
             *   <dd>
             *     Number of columns, assumed as 1 if zero or negative.
             *   </dd>
             *
             *   <dt>`labels-on-top`</dt>
             *   <dd>
             *     Optional, move the labels in the child `<vaadin-form-item>`
             *     elements on top of the input fields. Labels are aside the
             *     input fields if omitted.
             *   </dd>
             * </dl>
             *
             * #### Examples
             *
             * <dl>
             *   <dt>`1`</dt>
             *   <dd>
             *     <p>The layout is always a single column, labels aside.
             *   </dd>
             *
             *   <dt>`1, 40em 2`</dt>
             *   <dd>
             *     <p>Sets two responsive steps:
             *     <ol>
             *       <li>When the layout width is < 40em, one column, labels aside.
             *       <li>Width >= 40em, two columns, labels aside.
             *     </ol>
             *   </dd>
             *
             *   <dt>`1 labels-on-top, 20em 1, 40em 2`</dt>
             *   <dd>
             *     <p>Default value. Three responsive steps:
             *     <ol>
             *       <li>Width < 20em, one column, labels on top.
             *       <li>20em <= width < 40em, one column, labels aside.
             *       <li>Width >= 40em, two columns, labels aside.
             *     </ol>
             *   </dd>
             * </dl>
             */
            columns: {
              type: String,
              value: '1 labels-on-top, 20em 1, 40em 2',
              observer: '_columnsChanged'
            },

            /**
             * Parsed value of the columns property
             */
            _parsedResponsiveSteps: Array,

            /**
             * Current number of columns in the layout
             */
            _columnCount: {
              type: Number
            },

            /**
             * Indicates that labels are on top
             */
            _labelsOnTop: {
              type: Boolean
            }
          };
        }

        static get observers() {
          return [
            '_invokeUpdateStyles(_columnCount, _labelsOnTop)'
          ];
        }

        ready() {
          // Here we create and attach a style element that we use for validating
          // CSS values in `columns`. We can’t add this to the `<template>`,
          // because Polymer will throw it away. We need to create this before
          // `super.ready()`, because `super.ready()` invokes `_columnsChanged`,
          // which invokes the `_parsedResponsiveSteps` parser method,
          // which requires `this._styleElement` to be already attached.
          this._styleElement = document.createElement('style');
          this.root.appendChild(this._styleElement);
          // Ensure there is a child text node in the style element
          this._styleElement.textContent = ' ';
          if (window.ShadyDOM) {
            // With ShadyDOM, setting textContent attaches text content nodes
            // asynchronously, but we need it right away.
            window.ShadyDOM.flush();
          }

          super.ready();

          this.addEventListener('iron-resize', this._selectResponsiveStep);
        }

        connectedCallback() {
          super.connectedCallback();

          Polymer.RenderStatus.beforeNextRender(this, this._selectResponsiveStep);
          Polymer.RenderStatus.beforeNextRender(this, this.updateStyles);
        }

        _naturalNumberOrOne(n) {
          if (typeof n === 'number' && n >= 1 && n < Infinity) return Math.floor(n);
          return 1;
        }

        _isValidCSSLength(value) {
          // Let us choose a CSS property for validating CSS <length> values:
          // - `border-spacing` accepts `<length> | inherit`, it’s the best! But
          //   it does not disallow invalid values at all in MSIE :-(
          // - `letter-spacing` and `word-spacing` accept
          //   `<length> | normal | inherit`, and disallows everything else, like
          //   `<percentage>`, `auto` and such, good enough.
          // - `word-spacing` is used since its shorter.

          // Disallow known keywords allowed as the `word-spacing` value
          if (value === 'inherit' || value === 'normal') return false;

          // Use the value in a stylesheet and check the parsed value. Invalid
          // input value results in empty parsed value.
          this._styleElement.firstChild.nodeValue = `#styleElement { word-spacing: ${value}; }`;
          return this._styleElement.sheet.cssRules[0].style.getPropertyValue('word-spacing') !== '';
        }

        _parseResponsiveSteps(columns) {
          return columns.toString().split(',').map(parts => {
            parts = parts.trim().split(/\s+/);
            // If the first part is a valid CSS length, then take it as minWidth
            const minWidth = this._isValidCSSLength(parts[0]) ? parts.shift() : 0;
            const [columns, labelsOnTop] = parts;
            return {
              minWidth: minWidth,
              columns: this._naturalNumberOrOne(parseInt(columns, 10)),
              labelsOnTop: labelsOnTop === 'labels-on-top'
            };
          });
        }

        _columnsChanged(columns) {
          this._parsedResponsiveSteps = this._parseResponsiveSteps(columns || '1 labels-on-top, 20em 1, 40em 2');
          this._selectResponsiveStep();
        }

        _selectResponsiveStep() {
          // Iterate through _parsedResponsiveSteps and choose the step
          let selectedStep;
          const tmpStyleProp = 'background-position';
          this._parsedResponsiveSteps.forEach(step => {
            // Convert minWidth to px units for comparison
            this.$.layout.style.setProperty(tmpStyleProp, step.minWidth);
            const stepMinWidthPx = parseFloat(getComputedStyle(this.$.layout).getPropertyValue(tmpStyleProp));

            // Compare step min-width with the host width, select the passed step
            if (stepMinWidthPx <= this.offsetWidth) {
              selectedStep = step;
            }
          });
          this.$.layout.style.removeProperty(tmpStyleProp);

          // Sometimes converting units is not possible, e.g, when element is
          // not connected. Then the `selectedStep` stays `undefined`.
          if (selectedStep) {
            // Apply the chosen responsive step’s properties
            this._columnCount = selectedStep.columns;
            this._labelsOnTop = selectedStep.labelsOnTop;
          }
        }

        _invokeUpdateStyles() {
          this.updateStyles();
        }

        /**
         * Set custom CSS property values and update the layout.
         */
        updateStyles(...args) {
          super.updateStyles(...args);

          /*
            The item width formula:

                itemWidth = colspan / columnCount * 100% - columnGap

            We have to subtract columnGap, because the column gap space is taken
            by item margins of 1/2 * gap on both sides
          */

          const columnGap = window.ShadyCSS
            ? window.ShadyCSS.getComputedStyleValue(this, '--vaadin-form-layout-column-gap')
            : getComputedStyle(this).getPropertyValue('--vaadin-form-layout-column-gap');

          Array.from(this.children).forEach(child => {
            let colspan = this._naturalNumberOrOne(parseFloat(child.getAttribute('colspan')));

            // Never span further than the number of columns
            colspan = Math.min(colspan, this._columnCount);

            const childRatio = colspan / this._columnCount;

            // Note: using 99.999% for 100% fixes rounding errors in MS Edge,
            // otherwise the items might wrap, resizing is wobbly
            child.style.width = `calc(${childRatio * 99.999}% - ${columnGap})`;

            if (child.localName === 'vaadin-form-item') {
              if (this._labelsOnTop) {
                child.setAttribute('label-on-top', '');
              } else {
                child.removeAttribute('label-on-top');
              }
            }
          });
        }
      }

      customElements.define(FormLayoutElement.is, FormLayoutElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin = window.Vaadin || {};
      Vaadin.FormLayoutElement = FormLayoutElement;
    })();
  </script>
</dom-module>
